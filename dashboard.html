<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Macroeconomic and Financial Review of Belgium</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,700;9..144,800&family=Overpass+Mono:wght@400;600&family=Figtree:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Belgian FPS Finance â€” Institutional dark dashboard
   Matching the screenshot: navy header, dark table,
   pill filters, sparkline visuals, mono data cells.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy: #131d33;
  --navy-mid: #1a2744;
  --navy-table: #16203a;
  --navy-row: #1c2a4a;
  --navy-hover: #223358;
  --steel: #4a7ab5;
  --sky: #7db4e0;
  --gold: #d4a843;
  --cream: #f0ede6;
  --white: #ffffff;
  --text-bright: #e8ecf2;
  --text-dim: #8899ad;
  --text-muted: #5a6b80;
  --green: #34d399;
  --red: #f87171;
  --orange: #fbbf24;
  --border-dark: #253050;
  --border-light: #d1d5db;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Figtree', sans-serif;
  background: var(--cream);
  color: #1e2a3a;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  background: linear-gradient(135deg, #101a2e 0%, var(--navy-mid) 100%);
  color: white;
  padding: 18px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.header-left { display: flex; align-items: center; gap: 16px; }
.be-flag {
  width: 40px; height: 40px; border-radius: 6px; overflow: hidden;
  display: flex; flex-shrink: 0; box-shadow: 0 0 0 2px rgba(255,255,255,0.15);
}
.be-flag .s { flex: 1; }
.be-flag .s:nth-child(1) { background: #2d2926; }
.be-flag .s:nth-child(2) { background: #ffd100; }
.be-flag .s:nth-child(3) { background: #ef3340; }

.header-text h1 {
  font-family: 'Figtree', sans-serif;
  font-size: 1.15rem; font-weight: 700; letter-spacing: 0.01em;
}
.header-text .sub {
  font-size: 0.75rem; opacity: 0.55; margin-top: 1px;
}
.header-right {
  text-align: right; font-size: 0.72rem; line-height: 1.5; color: var(--text-dim);
}
.header-right .ital { font-style: italic; color: var(--gold); font-weight: 600; font-size: 0.78rem; }

/* â”€â”€ CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.controls {
  background: white; border-bottom: 1px solid var(--border-light);
  padding: 10px 32px; display: flex; align-items: center;
  justify-content: space-between; gap: 12px; flex-wrap: wrap;
}
.ctrl-left { display: flex; align-items: center; gap: 10px; }

.status { display: flex; align-items: center; gap: 7px; font-size: 0.76rem; color: #6b7280; }
.dot {
  width: 8px; height: 8px; border-radius: 50%; background: var(--green);
  box-shadow: 0 0 5px rgba(52,211,153,0.5);
}
.dot.loading { background: var(--orange); animation: blink 1s infinite; }
.dot.err { background: var(--red); }
@keyframes blink { 50% { opacity: 0.3; } }

.btn {
  font-family: 'Figtree'; font-size: 0.74rem; font-weight: 600;
  padding: 6px 14px; border-radius: 6px; cursor: pointer;
  border: 1px solid var(--border-light); background: white; color: #374151;
  transition: all 0.12s; display: inline-flex; align-items: center; gap: 5px;
}
.btn:hover { background: #f3f4f6; }
.btn.primary { background: var(--navy-mid); color: white; border-color: var(--navy-mid); }
.btn.primary:hover { background: #223358; }

.pills { display: flex; gap: 5px; flex-wrap: wrap; }
.pill {
  font-size: 0.68rem; font-weight: 600; padding: 5px 12px; border-radius: 20px;
  border: 1px solid var(--border-light); background: white; color: #6b7280;
  cursor: pointer; transition: all 0.12s; text-transform: uppercase; letter-spacing: 0.04em;
}
.pill:hover, .pill.on { background: var(--navy-mid); color: white; border-color: var(--navy-mid); }

/* â”€â”€ CONFIG BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.config-banner {
  background: #fffbeb; border-bottom: 1px solid #fde68a;
  padding: 10px 32px; font-size: 0.78rem; color: #92400e;
  display: none; align-items: center; gap: 10px;
}
.config-banner input {
  font-family: 'Overpass Mono'; font-size: 0.74rem; padding: 4px 10px;
  border: 1px solid #fde68a; border-radius: 4px; flex: 1; max-width: 500px;
}
.config-banner .btn { font-size: 0.7rem; padding: 4px 10px; }

/* â”€â”€ TABLE AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap { padding: 20px 32px 40px; }

.section-head {
  font-family: 'Figtree'; font-size: 0.95rem; font-weight: 700;
  color: var(--navy-mid); padding: 14px 0 6px;
  border-bottom: 2px solid var(--navy-mid);
  margin-top: 20px; display: flex; align-items: center; gap: 8px;
}
.section-head:first-of-type { margin-top: 0; }

table {
  width: 100%; border-collapse: collapse; font-size: 0.8rem;
  background: var(--navy); border-radius: 8px; overflow: hidden;
  margin-bottom: 4px;
}
thead th {
  background: var(--navy-mid); color: var(--text-dim);
  font-weight: 600; font-size: 0.68rem; text-transform: uppercase;
  letter-spacing: 0.06em; padding: 10px 12px; text-align: left;
  border-bottom: 1px solid var(--border-dark);
}
tbody tr {
  border-bottom: 1px solid var(--border-dark);
  transition: background 0.1s;
  cursor: pointer;
}
tbody tr:hover { background: var(--navy-hover); }
tbody td {
  padding: 12px 12px; color: var(--text-bright);
  vertical-align: top; line-height: 1.45;
}

/* Column sizing */
th:nth-child(1),td:nth-child(1) { width: 3%; text-align: center; color: var(--text-muted); }
th:nth-child(2),td:nth-child(2) { width: 20%; }
th:nth-child(3),td:nth-child(3) { width: 6%; text-align: center; }
th:nth-child(4),td:nth-child(4) { width: 8%; text-align: center; }
th:nth-child(5),td:nth-child(5) { width: 8%; text-align: center; }
th:nth-child(6),td:nth-child(6) { width: 5%; text-align: center; }
th:nth-child(7),td:nth-child(7) { width: 11%; }
th:nth-child(8),td:nth-child(8) { width: 7%; text-align: center; }
th:nth-child(9),td:nth-child(9) { width: 32%; }

.ind-name { color: var(--sky); font-weight: 600; }
.src-badge {
  font-family: 'Overpass Mono'; font-size: 0.66rem; font-weight: 600;
  padding: 2px 7px; border-radius: 3px; letter-spacing: 0.02em;
}
.src-nbb { background: rgba(74,122,181,0.2); color: var(--sky); }
.src-ec { background: rgba(251,191,36,0.15); color: #fbbf24; }
.src-statbel { background: rgba(52,211,153,0.15); color: var(--green); }
.src-fbp { background: rgba(248,113,113,0.15); color: var(--red); }
.val {
  font-family: 'Overpass Mono'; font-size: 0.8rem; font-weight: 600;
  white-space: pre-line;
}
.trend { font-size: 1.1rem; font-weight: 700; }
.trend.up { color: var(--green); }
.trend.down { color: var(--red); }
.trend.flat { color: var(--text-muted); }

canvas.spark { display: block; }

.update-dt {
  font-family: 'Overpass Mono'; font-size: 0.7rem; color: var(--text-muted);
}
.comment {
  font-size: 0.76rem; color: var(--text-dim); line-height: 1.5;
}

/* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.footer {
  background: white; border-top: 1px solid var(--border-light);
  padding: 14px 32px; font-size: 0.7rem; color: #9ca3af;
  display: flex; justify-content: space-between; flex-wrap: wrap; gap: 8px;
}
.footer strong { color: #6b7280; }

/* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(10,15,28,0.75);
  z-index: 1000; display: none; align-items: center; justify-content: center;
  backdrop-filter: blur(4px);
  animation: fadeIn 0.15s ease;
}
.modal-overlay.open { display: flex; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.modal {
  background: var(--navy); border: 1px solid var(--border-dark);
  border-radius: 12px; width: 90%; max-width: 860px; max-height: 88vh;
  display: flex; flex-direction: column; overflow: hidden;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  animation: slideUp 0.2s ease;
}
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.modal-head {
  padding: 18px 24px; display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid var(--border-dark); flex-shrink: 0;
}
.modal-head h2 {
  font-family: 'Figtree'; font-size: 1.05rem; font-weight: 700; color: var(--text-bright);
}
.modal-head .modal-sub {
  font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;
}
.modal-close {
  width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--border-dark);
  background: transparent; color: var(--text-dim); font-size: 1.1rem;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.12s;
}
.modal-close:hover { background: var(--navy-hover); color: var(--text-bright); }

.modal-body {
  padding: 20px 24px; overflow-y: auto; flex: 1;
}

/* Chart area */
.modal-chart {
  background: var(--navy-mid); border-radius: 8px; padding: 16px;
  margin-bottom: 20px; position: relative;
}
.modal-chart canvas { width: 100% !important; height: 280px !important; }

/* Stats row */
.modal-stats {
  display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;
}
.stat-card {
  flex: 1; min-width: 120px; background: var(--navy-mid); border-radius: 8px;
  padding: 12px 16px;
}
.stat-card .stat-label {
  font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.05em;
  color: var(--text-muted); margin-bottom: 4px;
}
.stat-card .stat-val {
  font-family: 'Overpass Mono'; font-size: 1.1rem; font-weight: 700; color: var(--text-bright);
}
.stat-card .stat-val.pos { color: var(--green); }
.stat-card .stat-val.neg { color: var(--red); }

/* Data table in modal */
.modal-table-wrap {
  border-radius: 8px; overflow: hidden; border: 1px solid var(--border-dark);
}
.modal-table {
  width: 100%; border-collapse: collapse; font-size: 0.78rem;
}
.modal-table thead th {
  background: var(--navy-mid); color: var(--text-dim);
  font-weight: 600; font-size: 0.66rem; text-transform: uppercase;
  letter-spacing: 0.06em; padding: 8px 14px; text-align: left;
  position: sticky; top: 0;
}
.modal-table tbody tr { border-bottom: 1px solid var(--border-dark); }
.modal-table tbody tr:hover { background: var(--navy-hover); }
.modal-table td {
  padding: 7px 14px; color: var(--text-bright);
  font-family: 'Overpass Mono'; font-size: 0.76rem;
}
.modal-table td:nth-child(2) { font-weight: 600; }
.modal-table .pos-val { color: var(--green); }
.modal-table .neg-val { color: var(--red); }
.modal-table .status-badge {
  font-size: 0.62rem; padding: 1px 6px; border-radius: 3px;
  font-family: 'Figtree'; font-weight: 600;
}
.modal-table .st-actual { background: rgba(52,211,153,0.15); color: var(--green); }
.modal-table .st-prov { background: rgba(251,191,36,0.15); color: var(--orange); }
.modal-table .st-break { background: rgba(248,113,113,0.15); color: var(--red); }

/* bar in table */
.bar-cell { position: relative; width: 100px; }
.bar-bg { height: 6px; border-radius: 3px; position: absolute; top: 50%; transform: translateY(-50%); }

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 1100px) {
  .header,.controls,.table-wrap,.footer { padding-left: 16px; padding-right: 16px; }
  table { min-width: 950px; }
  .table-wrap { overflow-x: auto; }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="be-flag"><div class="s"></div><div class="s"></div><div class="s"></div></div>
    <div class="header-text">
      <div class="sub">Federal Public Service Finance</div>
      <h1>Macroeconomic and Financial Review of Belgium</h1>
      <div class="sub" id="dateLabel"></div>
    </div>
  </div>
  <div class="header-right">
    <div class="ital">Expertise and Strategic Support</div>
    Research Department<br>Data and Statistics
  </div>
</div>

<div class="controls">
  <div class="ctrl-left">
    <div class="status">
      <div class="dot loading" id="dot"></div>
      <span id="statusText">Loading dataâ€¦</span>
    </div>
    <button class="btn primary" onclick="fetchData()">â†» Refresh All</button>
    <button class="btn" onclick="toggleConfig()">âš™ Configure</button>
  </div>
  <div class="pills" id="pills"></div>
</div>

<div class="config-banner" id="configBanner">
  <span>âš  Set your GitHub raw CSV URL:</span>
  <input id="csvUrl" placeholder="https://raw.githubusercontent.com/YOUR_USER/belgian-macro-pipeline/main/data/belgian_macro_export.csv">
  <button class="btn primary" onclick="saveConfig()">Save & Reload</button>
</div>

<div class="table-wrap" id="tableWrap"></div>

<div class="footer">
  <div>
    <strong>Sources:</strong> NBB = National Bank of Belgium Â· EC = European Commission Â·
    StatBel = Belgian Statistical Office Â· FBP = Federal Bureau of Planning
  </div>
  <div>Data fetched from GitHub repo Â· Auto-updated daily at 06:00 CET</div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-head">
      <div>
        <h2 id="modalTitle">â€”</h2>
        <div class="modal-sub" id="modalSub">â€”</div>
      </div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-stats" id="modalStats"></div>
      <div class="modal-chart"><canvas id="modalChart"></canvas></div>
      <div class="modal-table-wrap">
        <table class="modal-table">
          <thead><tr>
            <th>Period</th><th>Value</th><th>Î” Change</th><th>Status</th><th>Bar</th>
          </tr></thead>
          <tbody id="modalTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_CSV_URL = localStorage.getItem('csv_url') || 'https://raw.githubusercontent.com/mdruszcz/belgian-macro-pipeline/main/data/belgian_macro_export.csv';

// Indicator display metadata â€” maps indicator_code to display settings
const INDICATOR_META = {
  GDP_QUARTERLY_YY:    { num: 1,  section: 'gdp', name: 'Quarterly GDP growth (Y-Y)', order: 1 },
  GDP_ANNUAL_YY:       { num: 2,  section: 'gdp', name: 'Annual GDP growth', order: 2 },
  PRIV_CONSUMPTION_YY: { num: 3,  section: 'gdp', name: 'Private final consumption', order: 3 },
  GOV_CONSUMPTION_YY:  { num: 4,  section: 'gdp', name: 'Gov. consumption expenditure', order: 4 },
  GFCF_ENTERPRISES_YY: { num: 5,  section: 'gdp', name: 'GFCF â€” Enterprises', order: 5 },
  GFCF_DWELLINGS_YY:   { num: 6,  section: 'gdp', name: 'GFCF â€” Dwellings', order: 6 },
  GFCF_PUBLIC_YY:      { num: 7,  section: 'gdp', name: 'GFCF â€” Public admin.', order: 7 },
  CHG_STOCKS_YY:       { num: 8,  section: 'gdp', name: 'Changes in stocks', order: 8 },
  NET_EXPORTS_YY:      { num: 9,  section: 'gdp', name: 'Net exports', order: 9 },
};

const SECTIONS = {
  gdp: { label: 'Gross Domestic Product', icon: 'ğŸ“Š' },
  confidence: { label: 'Confidence & Sentiment', icon: 'ğŸ“ˆ' },
  prices: { label: 'Production & Prices', icon: 'ğŸ­' },
  labour: { label: 'Labour Costs', icon: 'ğŸ’¼' },
  employment: { label: 'Employment', icon: 'ğŸ‘¥' },
  unemployment: { label: 'Unemployment', icon: 'ğŸ“‰' },
  business: { label: 'Business Environment', icon: 'ğŸ¢' },
  fiscal: { label: 'Government Finances', icon: 'ğŸ›' },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let DATA = {}; // indicator_code â†’ [{period, value, obs_status, ...}]
let activeFilter = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = lines[0].split(',');
  return lines.slice(1).map(line => {
    const vals = line.split(',');
    const obj = {};
    headers.forEach((h, i) => obj[h.trim()] = (vals[i] || '').trim());
    return obj;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchData() {
  const url = localStorage.getItem('csv_url') || DEFAULT_CSV_URL;
  const dot = document.getElementById('dot');
  const statusText = document.getElementById('statusText');

  if (!url) {
    dot.className = 'dot err';
    statusText.textContent = 'No CSV URL configured â€” click âš™ Configure';
    document.getElementById('configBanner').style.display = 'flex';
    return;
  }

  dot.className = 'dot loading';
  statusText.textContent = 'Fetching from GitHubâ€¦';

  try {
    const resp = await fetch(url + '?t=' + Date.now()); // cache-bust
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const text = await resp.text();
    const rows = parseCSV(text);

    // Group by indicator_code
    DATA = {};
    rows.forEach(row => {
      const code = row.indicator_code;
      if (!DATA[code]) DATA[code] = [];
      DATA[code].push({
        period: row.period,
        value: parseFloat(row.value),
        obs_status: row.obs_status,
        unit: row.unit,
        source: row.source_agency,
        name: row.name,
        fetched_at: row.fetched_at,
      });
    });

    // Sort each series by period
    Object.values(DATA).forEach(series => series.sort((a, b) => a.period.localeCompare(b.period)));

    const totalRows = rows.length;
    const indicators = Object.keys(DATA).length;
    dot.className = 'dot';
    statusText.textContent = `${indicators} indicators Â· ${totalRows} observations loaded`;

    render();
  } catch (err) {
    dot.className = 'dot err';
    statusText.textContent = `Error: ${err.message}`;
    console.error(err);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPARKLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawSpark(canvas, values, color) {
  if (!canvas || values.length < 2) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width = 100;
  const H = canvas.height = 32;
  const pad = 3;
  const vs = values.slice(-20);
  const min = Math.min(...vs);
  const max = Math.max(...vs);
  const range = max - min || 1;

  ctx.clearRect(0, 0, W, H);

  // Area fill
  ctx.beginPath();
  vs.forEach((v, i) => {
    const x = pad + (i / (vs.length - 1)) * (W - 2 * pad);
    const y = H - pad - ((v - min) / range) * (H - 2 * pad);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  const lx = pad + (W - 2 * pad);
  ctx.lineTo(lx, H); ctx.lineTo(pad, H); ctx.closePath();
  ctx.fillStyle = color + '20';
  ctx.fill();

  // Line
  ctx.beginPath();
  vs.forEach((v, i) => {
    const x = pad + (i / (vs.length - 1)) * (W - 2 * pad);
    const y = H - pad - ((v - min) / range) * (H - 2 * pad);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.strokeStyle = color;
  ctx.lineWidth = 1.8;
  ctx.stroke();

  // End dot
  const lastV = vs[vs.length - 1];
  const lastY = H - pad - ((lastV - min) / range) * (H - 2 * pad);
  ctx.beginPath();
  ctx.arc(lx, lastY, 2.5, 0, Math.PI * 2);
  ctx.fillStyle = color;
  ctx.fill();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TREND LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getTrend(series) {
  if (series.length < 2) return 'flat';
  const last = series[series.length - 1].value;
  const prev = series[series.length - 2].value;
  if (last > prev + 0.05) return 'up';
  if (last < prev - 0.05) return 'down';
  return 'flat';
}

function trendArrow(t) {
  if (t === 'up') return '<span class="trend up">â†—</span>';
  if (t === 'down') return '<span class="trend down">â†˜</span>';
  return '<span class="trend flat">â†’</span>';
}

function trendColor(t) {
  if (t === 'up') return '#34d399';
  if (t === 'down') return '#f87171';
  return '#8899ad';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtValue(val, unit) {
  const v = val.toFixed(1).replace('.', ',');
  if (unit === 'percent_yy') return v + '%';
  if (unit === 'pp_contribution') return v + ' pp';
  return v;
}

function fmtDate(isoStr) {
  if (!isoStr) return 'â€”';
  return isoStr.substring(0, 10).replace(/-/g, '-');
}

function srcClass(s) {
  const l = (s || '').toLowerCase();
  if (l === 'nbb') return 'src-nbb';
  if (l === 'ec') return 'src-ec';
  if (l === 'statbel') return 'src-statbel';
  return 'src-fbp';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-COMMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateComment(code, series) {
  if (series.length < 2) return '';
  const last = series[series.length - 1];
  const prev = series[series.length - 2];
  const meta = INDICATOR_META[code] || {};
  const name = meta.name || last.name || code;
  const diff = (last.value - prev.value).toFixed(1).replace('.', ',');
  const sign = last.value > prev.value ? '+' : '';
  const status = last.obs_status === 'P' ? ' (provisional)' : '';
  const val = fmtValue(last.value, last.unit);

  return `${name} reached ${val} in ${last.period}${status}. ` +
         `Change vs ${prev.period}: ${sign}${diff} ${last.unit === 'pp_contribution' ? 'pp' : 'p.p.'}.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const wrap = document.getElementById('tableWrap');
  let html = '';

  // Group indicators by section
  const bySec = {};
  for (const [code, series] of Object.entries(DATA)) {
    const meta = INDICATOR_META[code];
    const sec = meta ? meta.section : 'other';
    if (!bySec[sec]) bySec[sec] = [];
    bySec[sec].push({ code, series, meta });
  }

  // Add 'other' section for unknown indicators
  if (bySec.other && !SECTIONS.other) {
    SECTIONS.other = { label: 'Other Indicators', icon: 'ğŸ“‹' };
  }

  for (const [secId, secMeta] of Object.entries(SECTIONS)) {
    const items = bySec[secId];
    if (!items || items.length === 0) continue;
    if (activeFilter && activeFilter !== secId) continue;

    items.sort((a, b) => (a.meta?.order || 99) - (b.meta?.order || 99));

    html += `<div class="section-head">${secMeta.icon} ${secMeta.label}</div>`;
    html += `<table><thead><tr>
      <th>#</th><th>Indicator</th><th>Source</th><th>Last data</th>
      <th>Value</th><th>Trend</th><th>Visual</th><th>Update</th><th>Comments</th>
    </tr></thead><tbody>`;

    items.forEach(({ code, series, meta }) => {
      const last = series[series.length - 1];
      const trend = getTrend(series);
      const num = meta?.num || 'â€”';
      const displayName = meta?.name || last.name || code;
      const sparkId = `spark_${code}`;

      html += `<tr onclick="openModal('${code}')">
        <td style="font-family:'Overpass Mono';font-size:0.7rem;">${num}</td>
        <td><span class="ind-name">${displayName}</span></td>
        <td><span class="src-badge ${srcClass(last.source)}">${last.source}</span></td>
        <td style="font-family:'Overpass Mono';font-size:0.72rem;">${last.period}</td>
        <td class="val">${fmtValue(last.value, last.unit)}</td>
        <td>${trendArrow(trend)}</td>
        <td><canvas id="${sparkId}" class="spark" width="100" height="32"></canvas></td>
        <td><span class="update-dt">${fmtDate(last.fetched_at)}</span></td>
        <td class="comment">${generateComment(code, series)}</td>
      </tr>`;
    });

    html += '</tbody></table>';
  }

  wrap.innerHTML = html;

  // Draw sparklines
  requestAnimationFrame(() => {
    for (const [code, series] of Object.entries(DATA)) {
      const canvas = document.getElementById(`spark_${code}`);
      const trend = getTrend(series);
      drawSpark(canvas, series.map(d => d.value), trendColor(trend));
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PILLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPills() {
  const el = document.getElementById('pills');
  let html = `<span class="pill on" onclick="setFilter(null,this)">ALL</span>`;
  for (const [id, s] of Object.entries(SECTIONS)) {
    html += `<span class="pill" onclick="setFilter('${id}',this)">${s.icon} ${s.label.toUpperCase()}</span>`;
  }
  el.innerHTML = html;
}

function setFilter(id, el) {
  document.querySelectorAll('.pill').forEach(p => p.classList.remove('on'));
  el.classList.add('on');
  activeFilter = id;
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleConfig() {
  const b = document.getElementById('configBanner');
  b.style.display = b.style.display === 'flex' ? 'none' : 'flex';
  document.getElementById('csvUrl').value = localStorage.getItem('csv_url') || '';
}

function saveConfig() {
  const url = document.getElementById('csvUrl').value.trim();
  if (url) {
    localStorage.setItem('csv_url', url);
    document.getElementById('configBanner').style.display = 'none';
    fetchData();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL â€” Detail view with chart + datatable
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let modalChartCtx = null;

function openModal(code) {
  const series = DATA[code];
  if (!series || series.length === 0) return;

  const meta = INDICATOR_META[code] || {};
  const name = meta.name || series[0].name || code;
  const unit = series[0].unit;

  // Filter to last ~10 years of data
  const now = new Date();
  const cutoffYear = now.getFullYear() - 10;
  const filtered = series.filter(d => {
    const year = parseInt(d.period.substring(0, 4));
    return year >= cutoffYear;
  });
  const displayData = filtered.length > 0 ? filtered : series.slice(-10);

  // Header
  document.getElementById('modalTitle').textContent = name;
  document.getElementById('modalSub').textContent =
    `${code} Â· Source: ${series[0].source} Â· ${displayData.length} observations Â· Last 10 years`;

  // Stats
  const last = displayData[displayData.length - 1];
  const prev = displayData.length >= 2 ? displayData[displayData.length - 2] : null;
  const values = displayData.map(d => d.value);
  const avg = values.reduce((a, b) => a + b, 0) / values.length;
  const min = Math.min(...values);
  const max = Math.max(...values);
  const change = prev ? last.value - prev.value : 0;

  const statsHtml = `
    <div class="stat-card">
      <div class="stat-label">Latest (${last.period})</div>
      <div class="stat-val ${last.value >= 0 ? 'pos' : 'neg'}">${fmtValue(last.value, unit)}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Change</div>
      <div class="stat-val ${change >= 0 ? 'pos' : 'neg'}">${change >= 0 ? '+' : ''}${change.toFixed(1).replace('.', ',')} ${unit === 'pp_contribution' ? 'pp' : 'p.p.'}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">10Y Average</div>
      <div class="stat-val">${avg.toFixed(1).replace('.', ',')}${unit === 'percent_yy' ? '%' : ' pp'}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">10Y Min</div>
      <div class="stat-val neg">${fmtValue(min, unit)}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">10Y Max</div>
      <div class="stat-val pos">${fmtValue(max, unit)}</div>
    </div>
  `;
  document.getElementById('modalStats').innerHTML = statsHtml;

  // Chart
  drawModalChart(displayData, unit);

  // Datatable â€” reversed (newest first)
  const absMax = Math.max(Math.abs(min), Math.abs(max)) || 1;
  let tableHtml = '';
  for (let i = displayData.length - 1; i >= 0; i--) {
    const d = displayData[i];
    const prevVal = i > 0 ? displayData[i - 1].value : null;
    const delta = prevVal !== null ? d.value - prevVal : null;
    const valClass = d.value >= 0 ? 'pos-val' : 'neg-val';
    const deltaStr = delta !== null
      ? `<span class="${delta >= 0 ? 'pos-val' : 'neg-val'}">${delta >= 0 ? '+' : ''}${delta.toFixed(1).replace('.', ',')}</span>`
      : 'â€”';

    let statusBadge = '';
    if (d.obs_status === 'A') statusBadge = '<span class="status-badge st-actual">Actual</span>';
    else if (d.obs_status === 'P') statusBadge = '<span class="status-badge st-prov">Provisional</span>';
    else if (d.obs_status === 'B') statusBadge = '<span class="status-badge st-break">Break</span>';
    else statusBadge = `<span class="status-badge">${d.obs_status || 'â€”'}</span>`;

    // Mini bar
    const barPct = Math.abs(d.value) / absMax * 100;
    const barColor = d.value >= 0 ? 'var(--green)' : 'var(--red)';
    const barLeft = d.value >= 0 ? '50%' : `${50 - barPct / 2}%`;
    const barWidth = barPct / 2;

    tableHtml += `<tr>
      <td>${d.period}</td>
      <td class="${valClass}">${fmtValue(d.value, unit)}</td>
      <td>${deltaStr}</td>
      <td>${statusBadge}</td>
      <td class="bar-cell">
        <div style="position:relative;width:100px;height:6px;background:rgba(255,255,255,0.05);border-radius:3px;">
          <div style="position:absolute;height:100%;border-radius:3px;background:${barColor};opacity:0.6;
            left:${d.value >= 0 ? '50%' : (50 - barWidth) + '%'};
            width:${barWidth}%;"></div>
          <div style="position:absolute;left:50%;top:-2px;width:1px;height:10px;background:rgba(255,255,255,0.15);"></div>
        </div>
      </td>
    </tr>`;
  }
  document.getElementById('modalTableBody').innerHTML = tableHtml;

  // Show
  document.getElementById('modalOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

// ESC key closes modal
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

function drawModalChart(data, unit) {
  const canvas = document.getElementById('modalChart');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;

  const rect = canvas.parentElement.getBoundingClientRect();
  const W = rect.width - 32;
  const H = 280;
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);

  const values = data.map(d => d.value);
  const labels = data.map(d => d.period);
  const min = Math.min(...values, 0);
  const max = Math.max(...values, 0);
  const range = max - min || 1;

  const padL = 50, padR = 20, padT = 20, padB = 40;
  const chartW = W - padL - padR;
  const chartH = H - padT - padB;

  ctx.clearRect(0, 0, W, H);

  // Zero line Y position
  const zeroY = padT + ((max - 0) / range) * chartH;

  // Grid lines
  const niceSteps = getNiceSteps(min, max, 6);
  ctx.textAlign = 'right';
  ctx.textBaseline = 'middle';
  ctx.font = '11px "Overpass Mono"';
  niceSteps.forEach(v => {
    const y = padT + ((max - v) / range) * chartH;
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(W - padR, y); ctx.stroke();
    ctx.fillStyle = '#5a6b80';
    const label = unit === 'percent_yy' ? v.toFixed(1) + '%' : v.toFixed(1) + 'pp';
    ctx.fillText(label, padL - 8, y);
  });

  // Zero line (thicker)
  ctx.strokeStyle = 'rgba(255,255,255,0.15)';
  ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(padL, zeroY); ctx.lineTo(W - padR, zeroY); ctx.stroke();

  // Bars
  const barW = Math.max(4, Math.min(28, (chartW / data.length) * 0.6));
  const gap = chartW / data.length;

  data.forEach((d, i) => {
    const x = padL + gap * i + gap / 2;
    const valY = padT + ((max - d.value) / range) * chartH;
    const barH = Math.abs(valY - zeroY);

    // Gradient bar
    const isPos = d.value >= 0;
    const barTop = isPos ? valY : zeroY;
    const grad = ctx.createLinearGradient(0, barTop, 0, barTop + barH);
    if (isPos) {
      grad.addColorStop(0, 'rgba(52,211,153,0.85)');
      grad.addColorStop(1, 'rgba(52,211,153,0.3)');
    } else {
      grad.addColorStop(0, 'rgba(248,113,113,0.3)');
      grad.addColorStop(1, 'rgba(248,113,113,0.85)');
    }

    ctx.fillStyle = grad;
    roundRect(ctx, x - barW / 2, barTop, barW, barH, 2);
    ctx.fill();

    // Provisional bars get a dashed outline
    if (d.obs_status === 'P') {
      ctx.strokeStyle = isPos ? 'rgba(52,211,153,0.5)' : 'rgba(248,113,113,0.5)';
      ctx.lineWidth = 1;
      ctx.setLineDash([3, 3]);
      roundRect(ctx, x - barW / 2, barTop, barW, barH, 2);
      ctx.stroke();
      ctx.setLineDash([]);
    }

    // X-axis labels
    const showLabel = data.length <= 15 || i % Math.ceil(data.length / 12) === 0 || i === data.length - 1;
    if (showLabel) {
      ctx.save();
      ctx.translate(x, H - padB + 14);
      ctx.rotate(-0.5);
      ctx.fillStyle = '#5a6b80';
      ctx.font = '10px "Overpass Mono"';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText(d.period, 0, 0);
      ctx.restore();
    }
  });

  // Trend line on top
  ctx.beginPath();
  data.forEach((d, i) => {
    const x = padL + gap * i + gap / 2;
    const y = padT + ((max - d.value) / range) * chartH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.strokeStyle = 'rgba(125,180,224,0.7)';
  ctx.lineWidth = 2;
  ctx.stroke();

  // End dot
  const lastX = padL + gap * (data.length - 1) + gap / 2;
  const lastY = padT + ((max - values[values.length - 1]) / range) * chartH;
  ctx.beginPath();
  ctx.arc(lastX, lastY, 4, 0, Math.PI * 2);
  ctx.fillStyle = 'var(--sky)';
  ctx.fill();
  ctx.strokeStyle = 'white';
  ctx.lineWidth = 2;
  ctx.stroke();
}

function roundRect(ctx, x, y, w, h, r) {
  if (h === 0) return;
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

function getNiceSteps(min, max, targetSteps) {
  const range = max - min || 1;
  const rough = range / targetSteps;
  const mag = Math.pow(10, Math.floor(Math.log10(rough)));
  const residual = rough / mag;
  let nice;
  if (residual <= 1.5) nice = 1 * mag;
  else if (residual <= 3) nice = 2 * mag;
  else if (residual <= 7) nice = 5 * mag;
  else nice = 10 * mag;

  const steps = [];
  let v = Math.ceil(min / nice) * nice;
  while (v <= max) {
    steps.push(parseFloat(v.toFixed(4)));
    v += nice;
  }
  return steps;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  const now = new Date();
  document.getElementById('dateLabel').textContent =
    now.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
  renderPills();
  fetchData();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
