<!DOCTYPE html>
<html lang="en" data-theme="soft">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Macroeconomic and Financial Review of Belgium</title>
<link href="https://fonts.googleapis.com/css2?family=Overpass+Mono:wght@400;600&family=Figtree:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê‚ïê DAY ‚Äî clean white ‚ïê‚ïê‚ïê */
[data-theme="day"] {
  --bg-page:#f7f7f5; --bg-header:linear-gradient(135deg,#1e3a5f,#2a5080); --bg-header-text:#fff;
  --bg-header-sub:rgba(255,255,255,.55); --bg-header-right:rgba(255,255,255,.6); --gold:#b58a2a;
  --bg-controls:#fff; --border-controls:#e5e7eb; --text-status:#6b7280;
  --bg-btn:#fff; --text-btn:#374151; --border-btn:#d1d5db; --bg-btn-hover:#f3f4f6;
  --bg-btn-primary:#2a5080; --text-btn-primary:#fff;
  --bg-pill:#fff; --text-pill:#6b7280; --border-pill:#d1d5db; --bg-pill-active:#2a5080; --text-pill-active:#fff;
  --bg-config:#fffbeb; --border-config:#fde68a; --text-config:#92400e;
  --text-section:#1e3a5f; --border-section:#1e3a5f;
  --bg-table:#fff; --bg-thead:#f1f5f9; --text-thead:#64748b; --border-table:#e2e8f0;
  --bg-row-hover:#f8fafc; --text-cell:#1e293b; --text-cell-muted:#94a3b8; --text-cell-dim:#64748b;
  --link-color:#2563eb; --src-nbb-bg:rgba(37,99,235,.08); --src-nbb-text:#2563eb;
  --green:#059669; --red:#dc2626; --orange:#d97706;
  --green-bg:rgba(5,150,105,.08); --red-bg:rgba(220,38,38,.08); --orange-bg:rgba(217,119,6,.08);
  --bg-footer:#fff; --border-footer:#e5e7eb; --text-footer:#9ca3af; --text-footer-strong:#6b7280;
  --bg-tip:#fff; --border-tip:#e2e8f0; --shadow-tip:rgba(0,0,0,.12);
  --tip-title:#2563eb; --tip-code:#94a3b8; --tip-desc:#64748b;
  --bg-modal-overlay:rgba(0,0,0,.35); --bg-modal:#fff; --border-modal:#e2e8f0;
  --text-modal-title:#1e293b; --text-modal-sub:#94a3b8;
  --bg-stat:#f8fafc; --text-stat-label:#94a3b8; --text-stat-val:#1e293b;
  --bg-chart:#f8fafc; --chart-grid:rgba(0,0,0,.06); --chart-zero:rgba(0,0,0,.12);
  --chart-label:#94a3b8; --chart-line:rgba(37,99,235,.45); --chart-dot:#2563eb; --chart-dot-ring:#fff;
  --chart-bar-pos:5,150,105; --chart-bar-neg:220,38,38;
  --bg-modal-table:#f8fafc; --modal-table-border:#e2e8f0;
  --modal-bar-bg:rgba(0,0,0,.04); --modal-bar-zero:rgba(0,0,0,.1);
}
/* ‚ïê‚ïê‚ïê SOFT ‚Äî warm muted ‚ïê‚ïê‚ïê */
[data-theme="soft"] {
  --bg-page:#f5f0ea; --bg-header:linear-gradient(135deg,#3b3228,#5a4a3a); --bg-header-text:#f5f0ea;
  --bg-header-sub:rgba(245,240,234,.5); --bg-header-right:rgba(245,240,234,.55); --gold:#c49a3c;
  --bg-controls:#ece6dc; --border-controls:#d9d0c3; --text-status:#7a6f63;
  --bg-btn:#ece6dc; --text-btn:#4a3f35; --border-btn:#d1c8ba; --bg-btn-hover:#e2dacf;
  --bg-btn-primary:#5a4a3a; --text-btn-primary:#f5f0ea;
  --bg-pill:#ece6dc; --text-pill:#7a6f63; --border-pill:#d1c8ba; --bg-pill-active:#5a4a3a; --text-pill-active:#f5f0ea;
  --bg-config:#fdf6ec; --border-config:#e8d5a8; --text-config:#7a5c20;
  --text-section:#3b3228; --border-section:#3b3228;
  --bg-table:#faf6f0; --bg-thead:#ece6dc; --text-thead:#7a6f63; --border-table:#ddd5c8;
  --bg-row-hover:#f0ebe3; --text-cell:#3b3228; --text-cell-muted:#a39888; --text-cell-dim:#7a6f63;
  --link-color:#8b6914; --src-nbb-bg:rgba(139,105,20,.1); --src-nbb-text:#8b6914;
  --green:#2d8659; --red:#b83c3c; --orange:#b87d1a;
  --green-bg:rgba(45,134,89,.1); --red-bg:rgba(184,60,60,.1); --orange-bg:rgba(184,125,26,.1);
  --bg-footer:#ece6dc; --border-footer:#d9d0c3; --text-footer:#a39888; --text-footer-strong:#7a6f63;
  --bg-tip:#faf6f0; --border-tip:#ddd5c8; --shadow-tip:rgba(0,0,0,.1);
  --tip-title:#8b6914; --tip-code:#a39888; --tip-desc:#7a6f63;
  --bg-modal-overlay:rgba(30,22,15,.4); --bg-modal:#faf6f0; --border-modal:#ddd5c8;
  --text-modal-title:#3b3228; --text-modal-sub:#a39888;
  --bg-stat:#ece6dc; --text-stat-label:#a39888; --text-stat-val:#3b3228;
  --bg-chart:#ece6dc; --chart-grid:rgba(0,0,0,.05); --chart-zero:rgba(0,0,0,.1);
  --chart-label:#a39888; --chart-line:rgba(139,105,20,.4); --chart-dot:#8b6914; --chart-dot-ring:#faf6f0;
  --chart-bar-pos:45,134,89; --chart-bar-neg:184,60,60;
  --bg-modal-table:#ece6dc; --modal-table-border:#ddd5c8;
  --modal-bar-bg:rgba(0,0,0,.04); --modal-bar-zero:rgba(0,0,0,.08);
}
/* ‚ïê‚ïê‚ïê NIGHT ‚Äî deep blue ‚ïê‚ïê‚ïê */
[data-theme="night"] {
  --bg-page:#0c1220; --bg-header:linear-gradient(135deg,#0a0f1c,#131d33); --bg-header-text:#e8ecf2;
  --bg-header-sub:rgba(232,236,242,.45); --bg-header-right:rgba(136,153,173,.8); --gold:#d4a843;
  --bg-controls:#111927; --border-controls:#1e2d45; --text-status:#5a6b80;
  --bg-btn:#111927; --text-btn:#8899ad; --border-btn:#1e2d45; --bg-btn-hover:#182438;
  --bg-btn-primary:#1e3a5f; --text-btn-primary:#e8ecf2;
  --bg-pill:#111927; --text-pill:#5a6b80; --border-pill:#1e2d45; --bg-pill-active:#1e3a5f; --text-pill-active:#e8ecf2;
  --bg-config:#1a1500; --border-config:#3d3000; --text-config:#d4a843;
  --text-section:#7db4e0; --border-section:#1e3a5f;
  --bg-table:#0f1826; --bg-thead:#131d33; --text-thead:#5a6b80; --border-table:#1a2744;
  --bg-row-hover:#182a42; --text-cell:#c8d2de; --text-cell-muted:#3d5068; --text-cell-dim:#5a6b80;
  --link-color:#7db4e0; --src-nbb-bg:rgba(125,180,224,.12); --src-nbb-text:#7db4e0;
  --green:#34d399; --red:#f87171; --orange:#fbbf24;
  --green-bg:rgba(52,211,153,.1); --red-bg:rgba(248,113,113,.1); --orange-bg:rgba(251,191,36,.1);
  --bg-footer:#111927; --border-footer:#1e2d45; --text-footer:#3d5068; --text-footer-strong:#5a6b80;
  --bg-tip:#0f1826; --border-tip:#1a2744; --shadow-tip:rgba(0,0,0,.5);
  --tip-title:#7db4e0; --tip-code:#3d5068; --tip-desc:#5a6b80;
  --bg-modal-overlay:rgba(5,8,15,.8); --bg-modal:#0f1826; --border-modal:#1a2744;
  --text-modal-title:#e8ecf2; --text-modal-sub:#5a6b80;
  --bg-stat:#131d33; --text-stat-label:#3d5068; --text-stat-val:#e8ecf2;
  --bg-chart:#131d33; --chart-grid:rgba(255,255,255,.04); --chart-zero:rgba(255,255,255,.12);
  --chart-label:#3d5068; --chart-line:rgba(125,180,224,.45); --chart-dot:#7db4e0; --chart-dot-ring:#0f1826;
  --chart-bar-pos:52,211,153; --chart-bar-neg:248,113,113;
  --bg-modal-table:#131d33; --modal-table-border:#1a2744;
  --modal-bar-bg:rgba(255,255,255,.03); --modal-bar-zero:rgba(255,255,255,.1);
}

*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Figtree',sans-serif;background:var(--bg-page);color:var(--text-cell);min-height:100vh;-webkit-font-smoothing:antialiased;transition:background .3s,color .3s}
.header{background:var(--bg-header);color:var(--bg-header-text);padding:18px 32px;display:flex;align-items:center;justify-content:space-between}
.header-left{display:flex;align-items:center;gap:16px}
.header-right{display:flex;align-items:center;gap:12px}
.be-flag{width:40px;height:40px;border-radius:6px;overflow:hidden;display:flex;flex-shrink:0;box-shadow:0 0 0 2px rgba(255,255,255,.15)}
.be-flag .s{flex:1}.be-flag .s:nth-child(1){background:#2d2926}.be-flag .s:nth-child(2){background:#ffd100}.be-flag .s:nth-child(3){background:#ef3340}
.header-text h1{font-size:1.15rem;font-weight:700;letter-spacing:.01em}
.header-text .sub{font-size:.75rem;color:var(--bg-header-sub);margin-top:1px}
.controls{background:var(--bg-controls);border-bottom:1px solid var(--border-controls);padding:10px 32px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;transition:background .3s}
.ctrl-left{display:flex;align-items:center;gap:10px}
.status{display:flex;align-items:center;gap:7px;font-size:.76rem;color:var(--text-status)}
.dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
.dot.loading{background:var(--orange);animation:blink 1s infinite}.dot.err{background:var(--red)}
@keyframes blink{50%{opacity:.3}}
.pill{font-size:.68rem;font-weight:600;padding:5px 12px;border-radius:20px;border:1px solid var(--border-pill);background:var(--bg-pill);color:var(--text-pill);cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.04em}
.pill:hover,.pill.on{background:var(--bg-pill-active);color:var(--text-pill-active);border-color:var(--bg-pill-active)}
.dd-wrap{position:relative;height:28px}
.dd-wrap.theme,.dd-wrap.lang{width:42px}
.theme-switcher,.lang-switch{display:flex;flex-direction:column;gap:2px;background:rgba(255,255,255,.1);border-radius:8px;padding:3px;position:absolute;top:0;left:0;right:0;z-index:100;transition:background .2s,box-shadow .2s}
.dd-wrap:hover .theme-switcher,.dd-wrap:hover .lang-switch{background:var(--bg-page);box-shadow:0 4px 12px rgba(0,0,0,.25)}
.theme-btn,.lang-btn{font-family:'Figtree';border-radius:6px;border:none;cursor:pointer;background:transparent;color:var(--bg-header-text);transition:all .15s;text-align:center;display:none;order:2;padding:4px 0;width:100%;height:28px;line-height:20px}
.theme-btn{font-size:.85rem}
.lang-btn{font-size:.7rem;font-weight:700}
.theme-btn.active,.lang-btn.active{display:block;order:1;opacity:1;background:var(--bg-page);color:var(--text-section);box-shadow:0 2px 4px rgba(0,0,0,.1)}
.dd-wrap:hover .theme-btn,.dd-wrap:hover .lang-btn{display:block;color:var(--text-section);opacity:.7}
.dd-wrap:hover .theme-btn.active,.dd-wrap:hover .lang-btn.active{box-shadow:none;background:transparent;opacity:1}
.dd-wrap:hover .theme-btn:hover,.dd-wrap:hover .lang-btn:hover{background:rgba(128,128,128,.15);opacity:1}
.table-wrap{padding:20px 32px 40px}
.section-head{font-size:.95rem;font-weight:700;color:var(--text-section);padding:14px 0 6px;border-bottom:2px solid var(--border-section);margin-top:20px;display:flex;align-items:center;gap:8px}
.section-head:first-of-type{margin-top:0}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:.8rem;background:var(--bg-table);border-radius:8px;margin-bottom:4px;transition:background .3s}
thead th{background:var(--bg-thead);color:var(--text-thead);font-weight:600;font-size:.68rem;text-transform:uppercase;letter-spacing:.06em;padding:10px 12px;text-align:left;border-bottom:1px solid var(--border-table)}
table thead th:first-child{border-top-left-radius:8px}
table thead th:last-child{border-top-right-radius:8px}
tbody tr{transition:background .1s;cursor:pointer}
tbody tr:hover{background:var(--bg-row-hover)}
tbody td{padding:12px;color:var(--text-cell);vertical-align:top;line-height:1.45;border-bottom:1px solid var(--border-table)}
table tbody tr:last-child td{border-bottom:none}
table tbody tr:last-child td:first-child{border-bottom-left-radius:8px}
table tbody tr:last-child td:last-child{border-bottom-right-radius:8px}
th:nth-child(1),td:nth-child(1){width:3%;text-align:center;color:var(--text-cell-muted)}
th:nth-child(2),td:nth-child(2){width:20%}th:nth-child(3),td:nth-child(3){width:6%;text-align:center}
th:nth-child(4),td:nth-child(4){width:8%;text-align:center}th:nth-child(5),td:nth-child(5){width:8%;text-align:center}
th:nth-child(6),td:nth-child(6){width:5%;text-align:center}th:nth-child(7),td:nth-child(7){width:11%}
th:nth-child(8),td:nth-child(8){width:7%;text-align:center}th:nth-child(9),td:nth-child(9){width:32%}
.src-badge{font-family:'Overpass Mono';font-size:.66rem;font-weight:600;padding:2px 7px;border-radius:3px;letter-spacing:.02em}
.src-nbb{background:var(--src-nbb-bg);color:var(--src-nbb-text)}
.val{font-family:'Overpass Mono';font-size:.8rem;font-weight:600}
.trend{font-size:1.1rem;font-weight:700}.trend.up{color:var(--green)}.trend.down{color:var(--red)}.trend.flat{color:var(--text-cell-muted)}
canvas.spark{display:block}
.update-dt{font-family:'Overpass Mono';font-size:.7rem;color:var(--text-cell-muted)}
.comment{font-size:.76rem;color:var(--text-cell-dim);line-height:1.5}
.footer{background:var(--bg-footer);border-top:1px solid var(--border-footer);padding:14px 32px;font-size:.7rem;color:var(--text-footer);display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;transition:background .3s}
.footer strong{color:var(--text-footer-strong)}
.ind-name{color:var(--link-color);font-weight:600;position:relative;cursor:pointer}
.ind-name .tip{display:none;position:absolute;left:0;top:calc(100% + 8px);z-index:50;width:320px;padding:12px 14px;background:var(--bg-tip);border:1px solid var(--border-tip);border-radius:8px;box-shadow:0 8px 24px var(--shadow-tip);pointer-events:none}
.ind-name:hover .tip{display:block;animation:tipIn .15s ease}
@keyframes tipIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
tr:nth-last-child(-n+3):nth-child(n+4) .ind-name .tip{top:auto;bottom:calc(100% + 8px)}
tr:nth-last-child(-n+3):nth-child(n+4) .ind-name:hover .tip{animation:tipUp .15s ease}
@keyframes tipUp{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.tip-title{font-size:.8rem;font-weight:700;color:var(--tip-title);margin-bottom:4px;line-height:1.3}
.tip-code{font-family:'Overpass Mono';font-size:.64rem;color:var(--tip-code);margin-bottom:6px}
.tip-desc{font-size:.72rem;color:var(--tip-desc);line-height:1.5}
.tip-meta{margin-top:8px;padding-top:6px;border-top:1px solid var(--border-tip);font-family:'Overpass Mono';font-size:.64rem;color:var(--tip-code);display:flex;gap:12px}
.modal-overlay{position:fixed;inset:0;background:var(--bg-modal-overlay);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.open{display:flex}
.modal{background:var(--bg-modal);border:1px solid var(--border-modal);border-radius:12px;width:90%;max-width:860px;max-height:88vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25);animation:slideUp .2s ease}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-head{padding:18px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border-modal);flex-shrink:0}
.modal-head h2{font-size:1.05rem;font-weight:700;color:var(--text-modal-title)}
.modal-head .modal-sub{font-size:.75rem;color:var(--text-modal-sub);margin-top:2px}
.modal-close{width:32px;height:32px;border-radius:6px;border:1px solid var(--border-modal);background:transparent;color:var(--text-modal-sub);font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s}
.modal-close:hover{background:var(--bg-row-hover);color:var(--text-cell)}
.modal-body{padding:20px 24px;overflow-y:auto;flex:1}
.modal-stats{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.stat-card{flex:1;min-width:120px;background:var(--bg-stat);border-radius:8px;padding:12px 16px}
.stat-card .stat-label{font-size:.68rem;text-transform:uppercase;letter-spacing:.05em;color:var(--text-stat-label);margin-bottom:4px}
.stat-card .stat-val{font-family:'Overpass Mono';font-size:1.1rem;font-weight:700;color:var(--text-stat-val)}
.stat-card .stat-val.pos{color:var(--green)}.stat-card .stat-val.neg{color:var(--red)}
.modal-chart{background:var(--bg-chart);border-radius:8px;padding:20px;margin-bottom:20px}
.modal-chart canvas{display:block}
.modal-table-wrap{border-radius:8px;overflow:hidden;border:1px solid var(--modal-table-border)}
.modal-table{width:100%;border-collapse:collapse;font-size:.78rem}
.modal-table thead th{background:var(--bg-modal-table);color:var(--text-thead);font-weight:600;font-size:.66rem;text-transform:uppercase;letter-spacing:.06em;padding:8px 14px;text-align:left;position:sticky;top:0;border-radius:0}
.modal-table tbody tr{border-bottom:1px solid var(--modal-table-border)}
.modal-table tbody tr:hover{background:var(--bg-row-hover)}
.modal-table td{padding:7px 14px;color:var(--text-cell);font-family:'Overpass Mono';font-size:.76rem;border-bottom:none;border-radius:0}
.modal-table td:nth-child(2){font-weight:600}
.modal-table .pos-val{color:var(--green)}.modal-table .neg-val{color:var(--red)}
.modal-table .status-badge{font-size:.62rem;padding:1px 6px;border-radius:3px;font-family:'Figtree';font-weight:600}
.modal-table .st-actual{background:var(--green-bg);color:var(--green)}
.modal-table .st-prov{background:var(--orange-bg);color:var(--orange)}
.modal-table .st-break{background:var(--red-bg);color:var(--red)}
.contrib-wrap{padding:0 32px 30px;display:flex;gap:20px}
.contrib-card{background:var(--bg-table);border-radius:10px;padding:24px 28px 18px;border:1px solid var(--border-table);flex:1;min-width:0;position:relative}
.contrib-title{font-size:.95rem;font-weight:700;color:var(--text-cell);margin-bottom:2px}
.contrib-sub{font-size:.7rem;color:var(--text-cell-muted);margin-bottom:16px}
.contrib-card canvas{display:block;width:100%}
.contrib-legend{display:flex;flex-wrap:wrap;gap:6px 16px;margin-top:14px;padding-top:12px;border-top:1px solid var(--border-table)}
.contrib-legend .leg{display:flex;align-items:center;gap:5px;font-size:.68rem;color:var(--text-cell-dim)}
.contrib-legend .leg .swatch{width:12px;height:12px;border-radius:2px;flex-shrink:0}
@media(max-width:1100px){.contrib-wrap{padding-left:16px;padding-right:16px;flex-direction:column}}

.dl-btn {
  position: absolute; right: 20px; top: 20px;
  background: transparent; border: none; cursor: pointer;
  color: var(--text-cell-muted); padding: 4px; border-radius: 4px; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center;
}
.dl-btn:hover { background: var(--bg-row-hover); color: var(--text-cell); }

.chart-tooltip {
  position: fixed; pointer-events: none; opacity: 0; z-index: 9999;
  background: var(--bg-tip); border: 1px solid var(--border-tip);
  border-radius: 6px; padding: 12px; font-size: 0.75rem; color: var(--text-cell);
  box-shadow: 0 8px 24px var(--shadow-tip); transition: opacity 0.15s;
  white-space: nowrap; font-family: 'Figtree', sans-serif;
}
.chart-tooltip .tt-title { font-weight: 700; margin-bottom: 8px; font-family: 'Overpass Mono', monospace; color: var(--tip-title); }
.chart-tooltip .tt-row { display: flex; justify-content: space-between; gap: 24px; margin-bottom: 4px; }
.chart-tooltip .tt-swatch { width: 10px; height: 10px; border-radius: 2px; display: inline-block; vertical-align: -1px; margin-right: 6px;}
</style>
</head>
<body>
<div class="header"><div class="header-left"><div class="be-flag"><div class="s"></div><div class="s"></div><div class="s"></div></div><div class="header-text"><h1 id="mainTitle">Macroeconomic and Financial Review of Belgium</h1><div class="sub" id="dateLabel"></div></div></div><div class="header-right"><div class="dd-wrap theme"><div class="theme-switcher"><button class="theme-btn" id="t-day" onclick="setTheme('day',this)">‚òÄ</button><button class="theme-btn active" id="t-soft" onclick="setTheme('soft',this)">‚óë</button><button class="theme-btn" id="t-night" onclick="setTheme('night',this)">‚òæ</button></div></div><div class="dd-wrap lang"><div class="lang-switch"><button class="lang-btn" id="btn-en" onclick="setLang('en')">EN</button><button class="lang-btn" id="btn-fr" onclick="setLang('fr')">FR</button><button class="lang-btn" id="btn-nl" onclick="setLang('nl')">NL</button></div></div></div></div>
<div class="controls"><div class="ctrl-left"><div class="status"><div class="dot loading" id="dot"></div><span id="statusText">Loading‚Ä¶</span></div></div><div class="pills" id="pills"></div></div>
<div class="table-wrap" id="tableWrap"></div>
<div class="contrib-wrap" id="contribWrap" style="display:none">
  <div class="contrib-card">
    <button class="dl-btn" onclick="downloadChart('contribCanvas', 'gdp_contributions')" title="T√©l√©charger (.png)">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
    </button>
    <div class="contrib-title" id="contribTitle">Annual real GDP growth and contributions</div>
    <div class="contrib-sub">in percentage points ¬∑ Source: NBB</div>
    <canvas id="contribCanvas"></canvas>
    <div class="contrib-legend" id="contribLegend"></div>
  </div>
  <div class="contrib-card" id="intlCard" style="display:none">
    <button class="dl-btn" onclick="downloadChart('intlCanvas', 'gdp_comparison')" title="T√©l√©charger (.png)">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
    </button>
    <div class="contrib-title" id="intlTitle">Quarterly real GDP growth</div>
    <div class="contrib-sub">(2010 = 100) ¬∑ Source: Eurostat</div>
    <canvas id="intlCanvas"></canvas>
    <div class="contrib-legend" id="intlLegend"></div>
  </div>
</div>
<div class="footer"><div id="ftSrc"><strong>Sources:</strong> NBB = National Bank of Belgium</div><div id="ftGit">Data from GitHub ¬∑ Auto-updated daily 06:00 CET</div></div>
<div id="chartTooltip" class="chart-tooltip"></div>
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()"><div class="modal"><div class="modal-head"><div><h2 id="modalTitle">‚Äî</h2><div class="modal-sub" id="modalSub">‚Äî</div></div><div style="display:flex;gap:8px;align-items:center"><button class="btn" onclick="exportModalCSV()" style="font-size:.68rem;padding:5px 10px">‚¨á Export CSV</button><button class="modal-close" onclick="closeModal()">‚úï</button></div></div><div class="modal-body"><div class="modal-stats" id="modalStats"></div><div class="modal-chart"><canvas id="modalChart"></canvas></div><div class="modal-table-wrap"><table class="modal-table"><thead><tr><th id="mThPer">Period</th><th id="mThVal">Value</th><th id="mThChg">Œî Change</th><th id="mThStat">Status</th><th id="mThBar">Bar</th></tr></thead><tbody id="modalTableBody"></tbody></table></div></div></div></div>
<script>
const DEFAULT_CSV_URL=localStorage.getItem('csv_url')||'https://raw.githubusercontent.com/mdruszcz/belgian-macro-pipeline/main/data/belgian_macro_export.csv';
const FORECAST_CSV_URL='https://raw.githubusercontent.com/mdruszcz/belgian-macro-pipeline/main/data/belgian_forecasts.csv';
let FORECASTS_RAW=[];
let LANG=localStorage.getItem('lang')||'en';
const T={title:{en:'Macroeconomic and Financial Review of Belgium',fr:'Revue macro√©conomique et financi√®re de la Belgique',nl:'Macro-economisch en financieel overzicht van Belgi√´'},loading:{en:'Loading‚Ä¶',fr:'Chargement‚Ä¶',nl:'Laden‚Ä¶'},fetching:{en:'Fetching‚Ä¶',fr:'R√©cup√©ration‚Ä¶',nl:'Ophalen‚Ä¶'},error:{en:'Error: ',fr:'Erreur : ',nl:'Fout: '},no_csv:{en:'No CSV URL available in configuration.',fr:'Aucune URL CSV disponible.',nl:'Geen CSV URL beschikbaar.'},all:{en:'ALL',fr:'TOUS',nl:'ALLE'},th_ind:{en:'Indicator',fr:'Indicateur',nl:'Indicator'},th_src:{en:'Source',fr:'Source',nl:'Bron'},th_last:{en:'Last data',fr:'Derni√®res donn√©es',nl:'Laatste data'},th_val:{en:'Value',fr:'Valeur',nl:'Waarde'},th_trend:{en:'Trend',fr:'Tendance',nl:'Trend'},th_vis:{en:'Visuel',fr:'Visuel',nl:'Visueel'},th_upd:{en:'Update',fr:'Mise √† jour',nl:'Update'},th_com:{en:'Comments',fr:'Commentaires',nl:'Opmerkingen'},ft_src:{en:'<strong>Sources:</strong> NBB = National Bank of Belgium',fr:'<strong>Sources:</strong> BNB = Banque Nationale de Belgique',nl:'<strong>Bronnen:</strong> NBB = Nationale Bank van Belgi√´'},ft_git:{en:'Data from GitHub ¬∑ Auto-updated daily 06:00 CET',fr:'Donn√©es GitHub ¬∑ Mise √† jour auto. 06:00 CET',nl:'Data via GitHub ¬∑ Auto-update 06:00 CET'},m_obs:{en:'observations',fr:'observations',nl:'waarnemingen'},m_last10:{en:'Last 10 years',fr:'10 derni√®res ann√©es',nl:'Laatste 10 jaar'},m_latest:{en:'Latest',fr:'Dernier',nl:'Laatste'},m_chg:{en:'Change',fr:'Changement',nl:'Verschil'},m_avg:{en:'10Y Average',fr:'Moyenne 10A',nl:'10J Gemid.'},m_min:{en:'10Y Min',fr:'Min 10A',nl:'10J Min'},m_max:{en:'10Y Max',fr:'Max 10A',nl:'10J Max'},m_th_per:{en:'Period',fr:'P√©riode',nl:'Periode'},m_th_val:{en:'Value',fr:'Valeur',nl:'Waarde'},m_th_chg:{en:'Œî Change',fr:'Œî Changement',nl:'Œî Verschil'},m_th_stat:{en:'Status',fr:'Statut',nl:'Status'},m_th_bar:{en:'Bar',fr:'Barre',nl:'Balk'},st_act:{en:'Actual',fr:'R√©el',nl:'Actueel'},st_prov:{en:'Provisional',fr:'Provisoire',nl:'Voorlopig'},st_brk:{en:'Break',fr:'Rupture',nl:'Breuk'},c_reached:{en:'reached',fr:'a atteint',nl:'bereikte'},c_in:{en:'in',fr:'en',nl:'in'},c_prov:{en:'(provisional)',fr:'(provisoire)',nl:'(voorlopig)'},c_vs:{en:'Change vs',fr:'Changement vs',nl:'Verschil met'}};
function t(k){return T[k]?.[LANG]||k;}
const M={
GDP_QUARTERLY_YY:{n:1,s:'gdp',name:{en:'Quarterly GDP growth (Y-Y)',fr:'Croissance trimestrielle du PIB (A-A)',nl:'Kwartaalgroei BBP (J-J)'},o:1,full:{en:'Gross Domestic Product ‚Äî Quarterly Y-Y Volume Change',fr:'Produit Int√©rieur Brut ‚Äî Variation trimestrielle (A-A)',nl:'Bruto Binnenlands Product ‚Äî Kwartaal J-J volumeverschil'},desc:{en:'Percentage change in real GDP vs same quarter previous year.',fr:'Variation en pourcentage du PIB r√©el par rapport au m√™me trimestre de l\'ann√©e pr√©c√©dente.',nl:'Procentuele verandering re√´el BBP t.o.v. zelfde kwartaal vorig jaar.'},sdmx:'B1GM',freq:'Q'},
GDP_ANNUAL_CY:{n:2,s:'gdp',name:{en:'Annual GDP growth',fr:'Croissance annuelle du PIB',nl:'Jaarlijkse BBP-groei'},o:2,full:{en:'Gross Domestic Product ‚Äî Annual Y-Y Volume Change',fr:'Produit Int√©rieur Brut ‚Äî Variation annuelle (A-A)',nl:'Bruto Binnenlands Product ‚Äî Jaarlijks J-J volumeverschil'},desc:{en:'Annual percentage change in total output, adjusted for inflation.',fr:'Variation annuelle en pourcentage de la production totale, corrig√©e de l\'inflation.',nl:'Jaarlijkse procentuele verandering totale output, gecorrigeerd voor inflatie.'},sdmx:'B1GM',freq:'A'},
INT_GDP_COMP:{n:3,s:'gdp',name:{en:'International GDP comparison',fr:'Comparaison internationale du PIB',nl:'Internationale BBP-vergelijking'},o:3,full:{en:'GDP Comparison (BE vs DE/FR/NL)',fr:'Comparaison du PIB (BE vs DE/FR/NL)',nl:'BBP Vergelijking (BE vs DE/FR/NL)'},desc:{en:'Index 2010=100. Combined index: Germany (50%), France (40%), Netherlands (10%).',fr:'Indice 2010=100. Indice combin√© : Allemagne (50%), France (40%), Pays-Bas (10%).',nl:'Index 2010=100. Gecombineerde index: Duitsland (50%), Frankrijk (40%), Nederland (10%).'},sdmx:'',freq:'Q'},
PRIV_CONSUMPTION_CY:{n:4,s:'gdp',name:{en:'Private final consumption',fr:'Consommation finale priv√©e',nl:'Particuliere consumptie'},o:4,full:{en:'Private Final Consumption Expenditure',fr:'D√©penses de consommation finale priv√©e',nl:'Particuliere consumptieve bestedingen'},desc:{en:'Household spending on goods and services ‚Äî typically ~50% of GDP.',fr:'D√©penses des m√©nages en biens et services ‚Äî g√©n√©ralement ~50% du PIB.',nl:'Gezinsuitgaven aan goederen en diensten ‚Äî typisch ~50% van het BBP.'},sdmx:'P31_S14_S15',freq:'A'},
GOV_CONSUMPTION_CY:{n:5,s:'gdp',name:{en:'Gov. consumption expenditure',fr:'D√©penses de consommation des APU',nl:'Overheidsconsumptie'},o:5,full:{en:'Final Consumption Expenditure of General Government',fr:'D√©penses de consommation finale des administrations publiques',nl:'Finale consumptieve bestedingen van de overheid'},desc:{en:'Government spending on public services ‚Äî healthcare, education, defence.',fr:'D√©penses publiques en services ‚Äî sant√©, √©ducation, d√©fense.',nl:'Overheidsuitgaven aan publieke diensten ‚Äî zorg, onderwijs, defensie.'},sdmx:'P3_S13',freq:'A'},
GFCF_ENTERPRISES_CY:{n:6,s:'gdp',name:{en:'GFCF ‚Äî Enterprises',fr:'FBCF ‚Äî Entreprises',nl:'BIK ‚Äî Bedrijven'},o:6,full:{en:'Gross Fixed Capital Formation by Enterprises',fr:'Formation brute de capital fixe par les entreprises',nl:'Bruto-investeringen in vaste activa door bedrijven'},desc:{en:'Business investment in machinery, equipment, IT. A leading confidence indicator.',fr:'Investissements des entreprises en machines, IT. Un indicateur avanc√© de confiance.',nl:'Bedrijfsinvesteringen in machines, uitrusting, IT. Een voorlopende vertrouwensindicator.'},sdmx:'P51_ENT',freq:'A'},
GFCF_DWELLINGS_CY:{n:7,s:'gdp',name:{en:'GFCF ‚Äî Dwellings',fr:'FBCF ‚Äî Logements',nl:'BIK ‚Äî Woningen'},o:7,full:{en:'Gross Fixed Capital Formation in Dwellings',fr:'Formation brute de capital fixe en logements',nl:'Bruto-investeringen in vaste activa in woningen'},desc:{en:'Residential construction ‚Äî new builds and major renovations. Sensitive to mortgage rates.',fr:'Construction r√©sidentielle ‚Äî logements neufs et r√©novations. Sensible aux taux hypoth√©caires.',nl:'Woningbouw ‚Äî nieuwbouw en grote renovaties. Gevoelig voor hypotheekrente.'},sdmx:'P51_DWE',freq:'A'},
GFCF_PUBLIC_CY:{n:8,s:'gdp',name:{en:'GFCF ‚Äî Public admin.',fr:'FBCF ‚Äî Administrations publiques',nl:'BIK ‚Äî Overheid'},o:8,full:{en:'Gross Fixed Capital Formation by Public Administrations',fr:'Formation brute de capital fixe par les APU',nl:'Bruto-investeringen in vaste activa door de overheid'},desc:{en:'Government infrastructure ‚Äî roads, rail, schools. Follows political investment cycles.',fr:'Infrastructures gouvernementales ‚Äî routes, rails, √©coles. Suit les cycles politiques.',nl:'Overheidsinfrastructuur ‚Äî wegen, spoor, scholen. Volgt politieke cycli.'},sdmx:'P51_PAD',freq:'A'},
CHG_STOCKS_CY:{n:9,s:'gdp',name:{en:'Changes in stocks',fr:'Variation des stocks',nl:'Voorraadverandering'},o:9,full:{en:'Changes in Inventories',fr:'Variation des stocks',nl:'Veranderingen in voorraden'},desc:{en:'Change in raw materials and finished goods held by firms. Highly volatile swing factor.',fr:'Variation des mati√®res premi√®res et produits finis. Facteur d\'ajustement tr√®s volatil.',nl:'Verandering in grondstoffen en eindproducten bij bedrijven. Zeer volatiele zwaaifactor.'},sdmx:'P52',freq:'A'},
NET_EXPORTS_CY:{n:10,s:'gdp',name:{en:'Net exports',fr:'Exportations nettes',nl:'Netto-export'},o:10,full:{en:'External Balance of Goods and Services',fr:'Solde ext√©rieur des biens et services',nl:'Extern saldo van goederen en diensten'},desc:{en:'Exports minus imports. Belgium is highly open (trade ~160% of GDP).',fr:'Exportations moins importations. La Belgique est tr√®s ouverte (commerce ~160% du PIB).',nl:'Export minus import. Belgi√´ is zeer open (handel ~160% van het BBP).'},sdmx:'B11',freq:'A'},
FC_GDP_VOL:{n:11,s:'gdp',name:{en:'‚ü∂ GDP forecast (consensus)',fr:'‚ü∂ Pr√©vision PIB (consensus)',nl:'‚ü∂ BBP-prognose (consensus)'},o:11,full:{en:'GDP Volume Growth ‚Äî Multi-Institution Forecast',fr:'Croissance du PIB en volume ‚Äî Pr√©visions multi-institutions',nl:'BBP-volumegroei ‚Äî Meervoudige prognose'},desc:{en:'Average GDP growth forecast from 13 institutions (FPB, NBB, EC, IMF, OECD, banks). Source: plan.be.',fr:'Pr√©vision moyenne de croissance du PIB de 13 institutions. Source : plan.be.',nl:'Gemiddelde BBP-groeiverwachting van 13 instellingen. Bron: plan.be.'},sdmx:'',freq:'F',forecast:true,fc_indicator:'GDP_VOL'},
FC_CPI:{n:1,s:'prices',name:{en:'‚ü∂ CPI forecast (consensus)',fr:'‚ü∂ Pr√©vision IPC (consensus)',nl:'‚ü∂ CPI-prognose (consensus)'},o:0.5,full:{en:'Consumer Price Index ‚Äî Multi-Institution Forecast',fr:'Indice des prix √† la consommation ‚Äî Pr√©visions multi-institutions',nl:'Consumentenprijsindex ‚Äî Meervoudige prognose'},desc:{en:'Average CPI growth forecast from 13 institutions. Source: plan.be.',fr:'Pr√©vision moyenne IPC de 13 institutions. Source : plan.be.',nl:'Gemiddelde CPI-groeiverwachting van 13 instellingen. Bron: plan.be.'},sdmx:'',freq:'F',forecast:true,fc_indicator:'CPI'},
FC_FISCAL_BAL:{n:1,s:'fiscal',name:{en:'‚ü∂ Fiscal balance forecast (consensus)',fr:'‚ü∂ Pr√©vision solde budg√©taire (consensus)',nl:'‚ü∂ Begrotingssaldo prognose (consensus)'},o:0.5,full:{en:'Government Fiscal Balance ‚Äî Multi-Institution Forecast',fr:'Solde de financement des APU ‚Äî Pr√©visions multi-institutions',nl:'Begrotingssaldo overheid ‚Äî Meervoudige prognose'},desc:{en:'Average fiscal balance forecast (% GDP) from 13 institutions. Source: plan.be.',fr:'Pr√©vision moyenne du solde budg√©taire (% PIB) de 13 institutions. Source : plan.be.',nl:'Gemiddelde begrotingssaldoverwachting (% BBP) van 13 instellingen. Bron: plan.be.'},sdmx:'',freq:'F',forecast:true,fc_indicator:'FISCAL_BAL'},
CONSUMER_CONFIDENCE_COMP:{n:1,s:'confidence',name:{en:"Consumer's confidence index",fr:'Indice de confiance des consommateurs',nl:'Consumentenvertrouwensindex'},o:1,full:{en:'Consumer Confidence Indicator ‚Äî BE vs EU27',fr:'Indicateur de confiance des consommateurs ‚Äî BE vs UE27',nl:'Indicator van het consumentenvertrouwen ‚Äî BE vs EU27'},desc:{en:'Monthly consumer confidence balance, seasonally adjusted. European Commission survey.',fr:'Solde mensuel de confiance des consommateurs, d√©saisonnalis√©. Enqu√™te de la Commission Europ√©enne.',nl:'Maandelijks saldo consumentenvertrouwen, seizoensgezuiverd. Enqu√™te Europese Commissie.'},sdmx:'ei_bssi_m_r2',freq:'M'}
};
const SECTIONS={gdp:{label:{en:'Gross Domestic Product',fr:'Produit Int√©rieur Brut',nl:'Bruto Binnenlands Product'}},confidence:{label:{en:'Confidence & Sentiment',fr:'Confiance et Sentiment',nl:'Vertrouwen & Sentiment'}},prices:{label:{en:'Production & Prices',fr:'Production et Prix',nl:'Productie & Prijzen'}},labour:{label:{en:'Labour Costs',fr:'Co√ªts de la Main-d\'≈ìuvre',nl:'Arbeidskosten'}},employment:{label:{en:'Employment',fr:'Emploi',nl:'Werkgelegenheid'}},unemployment:{label:{en:'Unemployment',fr:'Ch√¥mage',nl:'Werkloosheid'}},business:{label:{en:'Business Environment',fr:'Environnement des Affaires',nl:'Bedrijfsklimaat'}},fiscal:{label:{en:'Government Finances',fr:'Finances Publiques',nl:'Overheidsfinanci√´n'}}};
let DATA={},activeFilter='gdp';

function setLang(l){LANG=l;localStorage.setItem('lang',l);document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));document.getElementById('btn-'+l).classList.add('active');updateStaticUI();if(Object.keys(DATA).length)render();renderPills();}
function updateStaticUI(){document.getElementById('mainTitle').textContent=t('title');document.getElementById('ftSrc').innerHTML=t('ft_src');document.getElementById('ftGit').textContent=t('ft_git');document.getElementById('mThPer').textContent=t('m_th_per');document.getElementById('mThVal').textContent=t('m_th_val');document.getElementById('mThChg').textContent=t('m_th_chg');document.getElementById('mThStat').textContent=t('m_th_stat');document.getElementById('mThBar').textContent=t('m_th_bar');const dL=document.getElementById('dateLabel');dL.textContent=new Date().toLocaleDateString(LANG==='nl'?'nl-BE':LANG==='fr'?'fr-BE':'en-GB',{day:'numeric',month:'long',year:'numeric'});if(document.getElementById('dot').classList.contains('err'))document.getElementById('statusText').textContent=t('no_csv');}

function setTheme(t,btn){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t);document.querySelectorAll('.theme-btn').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');if(Object.keys(DATA).length)render();}
function loadTheme(){const t=localStorage.getItem('theme')||'soft';document.documentElement.setAttribute('data-theme',t);document.querySelectorAll('.theme-btn').forEach(b=>b.classList.remove('active'));const btn=document.getElementById('t-'+t);if(btn)btn.classList.add('active');}
function gc(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
function parseCSV(t){const l=t.trim().split('\n'),h=l[0].split(',');return l.slice(1).map(r=>{const v=r.split(','),o={};h.forEach((k,i)=>o[k.trim()]=(v[i]||'').trim());return o});}
function fmtV(v,u){const s=v.toFixed(1).replace('.',',');return u==='pp_contribution'?s+' pp':u==='pct_gdp'?s+'% GDP':(u==='index_2010'||u==='comp_index'||u==='balance')?s:s+'%';}
function fmtD(s){return s?s.substring(0,10):'‚Äî';}
function trend(s){if(s.length<2)return'flat';const d=s[s.length-1].value-s[s.length-2].value;return d>.05?'up':d<-.05?'down':'flat';}
function tArr(t){return t==='up'?'<span class="trend up">‚Üó</span>':t==='down'?'<span class="trend down">‚Üò</span>':'<span class="trend flat">‚Üí</span>';}
function comment(c,s){
    if(s.length<2)return'';
    const l=s[s.length-1],p=s[s.length-2];
    if(c==='INT_GDP_COMP'){
        const bv=l.be_value.toFixed(1).replace('.',',');
        const cv=l.value.toFixed(1).replace('.',',');
        const diff=(l.be_value-l.value);
        const enStr=`Belgian economy has grown to a level of ${bv} since 2008, while the combined index of Germany(50%), France(40%) and Netherlands(10%) has grown to a level of ${cv}, ${diff>=0?'outperforming':'underperforming'} the composite in the measured period.`;
        const frStr=`L'√©conomie belge a atteint un niveau de ${bv} depuis 2008, tandis que l'indice combin√© de l'Allemagne(50%), la France(40%) et les Pays-Bas(10%) a atteint ${cv}.`;
        const nlStr=`De Belgische economie is gegroeid naar een niveau van ${bv} sinds 2008, terwijl de gecombineerde index (DE 50%, FR 40%, NL 10%) naar ${cv} is gegroeid.`;
        return LANG==='fr'?frStr:LANG==='nl'?nlStr:enStr;
    }
    if(c==='CONSUMER_CONFIDENCE_COMP'){
        const bv = l.value.toFixed(1).replace('.',',');
        const euv = l.eu_value.toFixed(1).replace('.',',');
        
        // Find Year-over-Year comparison
        const yr = parseInt(l.period.substring(0,4));
        const mth = l.period.substring(4); // e.g. "-11" or "-M11"
        const pyRow = s.find(x => x.period === String(yr - 1) + mth);
        
        if (pyRow) {
            const diff = (l.value - pyRow.value);
            const diffStr = Math.abs(diff).toFixed(1).replace('.',',');
            const dirEN = diff >= 0 ? 'higher' : 'lower';
            const dirFR = diff >= 0 ? 'sup√©rieur' : 'inf√©rieur';
            const dirNL = diff >= 0 ? 'hoger' : 'lager';
            
            const enStr = `The EC's consumers confidence index is ${bv} for ${l.period}. Compared to the same month last year, it is ${dirEN} by ${diffStr} point${diffStr==='1,0'?'':'s'}.`;
            const frStr = `L'indice de confiance des consommateurs de la CE est de ${bv} pour ${l.period}. Par rapport au m√™me mois l'an dernier, il est ${dirFR} de ${diffStr} point${diffStr==='1,0'?'':'s'}.`;
            const nlStr = `De consumentenvertrouwensindex van de EC is ${bv} voor ${l.period}. Vergeleken met dezelfde maand vorig jaar is deze ${diffStr} punt${diffStr==='1,0'?'':'en'} ${dirNL}.`;
            return LANG==='fr'?frStr:LANG==='nl'?nlStr:enStr;
        } else {
            return LANG==='fr'?`BE: ${bv} (UE: ${euv})`:LANG==='nl'?`BE: ${bv} (EU: ${euv})`:`BE: ${bv} (EU: ${euv})`;
        }
    }
    const m=M[c]||{},d=(l.value-p.value).toFixed(1).replace('.',','),sg=l.value>p.value?'+':'',st=l.obs_status==='P'?' '+t('c_prov'):'';return`${m.name?.[LANG]||c} ${t('c_reached')} ${fmtV(l.value,l.unit)} ${t('c_in')} ${l.period}${st}. ${t('c_vs')} ${p.period}: ${sg}${d} ${m.unit==='balance'?'pts':'p.p.'}`;
}

async function fetchData(){const url=localStorage.getItem('csv_url')||DEFAULT_CSV_URL;const dot=document.getElementById('dot'),st=document.getElementById('statusText');if(!url){dot.className='dot err';st.textContent=t('no_csv');return;}dot.className='dot loading';st.textContent=t('fetching');try{const r=await fetch(url+'?t='+Date.now());if(!r.ok)throw new Error('HTTP '+r.status);const rows=parseCSV(await r.text());DATA={};rows.forEach(r=>{const c=r.indicator_code;if(!DATA[c])DATA[c]=[];DATA[c].push({period:r.period,value:parseFloat(r.value),obs_status:r.obs_status,unit:r.unit,source:r.source_agency,name:r.name,fetched_at:r.fetched_at});});Object.values(DATA).forEach(s=>s.sort((a,b)=>a.period.localeCompare(b.period)));
    if(DATA['EUROSTAT_GDP_Q_MEUR'] && DATA['EUROSTAT_GDP_Q_MEUR_DE'] && DATA['EUROSTAT_GDP_Q_MEUR_FR'] && DATA['EUROSTAT_GDP_Q_MEUR_NL']) {
        let comp = [];
        DATA['EUROSTAT_GDP_Q_MEUR'].forEach(b => {
            let p = b.period;
            let d = DATA['EUROSTAT_GDP_Q_MEUR_DE'].find(x => x.period === p);
            let f = DATA['EUROSTAT_GDP_Q_MEUR_FR'].find(x => x.period === p);
            let n = DATA['EUROSTAT_GDP_Q_MEUR_NL'].find(x => x.period === p);
            if(d && f && n) {
                let val = (d.value * 0.5) + (f.value * 0.4) + (n.value * 0.1);
                comp.push({
                    period: p,
                    value: val,
                    be_value: b.value,
                    obs_status: b.obs_status,
                    unit: 'comp_index',
                    source: 'EC',
                    name: 'International GDP comparison',
                    fetched_at: b.fetched_at
                });
            }
        });
        if(comp.length > 0) DATA['INT_GDP_COMP'] = comp;
    }
    
    if(DATA['BE_CONSUMER_CONFIDENCE'] && DATA['EU_CONSUMER_CONFIDENCE']) {
        let comp_cc = [];
        DATA['BE_CONSUMER_CONFIDENCE'].forEach(b => {
            let eu = DATA['EU_CONSUMER_CONFIDENCE'].find(x => x.period === b.period);
            if(eu) {
                comp_cc.push({
                    period: b.period,
                    value: b.value,
                    eu_value: eu.value,
                    obs_status: b.obs_status,
                    unit: 'balance',
                    source: 'EC',
                    name: "Consumer's confidence index",
                    fetched_at: b.fetched_at
                });
            }
        });
        if(comp_cc.length > 0) DATA['CONSUMER_CONFIDENCE_COMP'] = comp_cc;
    }

    // ‚îÄ‚îÄ Load forecasts ‚îÄ‚îÄ
    try {
        const fr=await fetch(FORECAST_CSV_URL+'?t='+Date.now());
        if(fr.ok){
            FORECASTS_RAW=parseCSV(await fr.text()).map(r=>({
                institution:r.institution, indicator:r.indicator, year:r.year,
                value:r.value?parseFloat(r.value):null, updated_at:r.updated_at||''
            }));
            buildForecastData();
        }
    } catch(e){ log && console.warn('Forecasts not loaded:', e); }
    dot.className='dot';st.textContent=`${Object.keys(DATA).length} indicators ¬∑ ${rows.length} ${t('m_obs')}`;render();}catch(e){dot.className='dot err';st.textContent=t('error')+e.message;}}

function buildForecastData(){
    const cutoff = new Date();
    cutoff.setMonth(cutoff.getMonth() - 6);
    const cutStr = cutoff.toISOString().substring(0,10);

    for(const [code, meta] of Object.entries(M)){
        if(!meta.forecast || !meta.fc_indicator) continue;
        const ind = meta.fc_indicator;
        const relevant = FORECASTS_RAW.filter(r =>
            r.indicator === ind && r.value !== null && r.updated_at >= cutStr
        );
        const byYear = {};
        relevant.forEach(r => {
            if(!byYear[r.year]) byYear[r.year] = [];
            byYear[r.year].push(r);
        });
        const series = [];
        for(const [year, entries] of Object.entries(byYear).sort((a,b)=>a[0].localeCompare(b[0]))){
            const avg = entries.reduce((s,e)=>s+e.value,0) / entries.length;
            series.push({
                period: year,
                value: Math.round(avg * 100) / 100,
                obs_status: 'F',
                unit: ind === 'FISCAL_BAL' ? 'pct_gdp' : 'percent_yy',
                source: 'FPB',
                name: meta.name?.en || code,
                fetched_at: entries[0].updated_at || '',
                _count: entries.length
            });
        }
        if(series.length > 0) DATA[code] = series;
    }
}

function drawSpark(cv,vals,tr){if(!cv||vals.length<2)return;const g=gc('--green'),r=gc('--red'),mu=gc('--text-cell-muted'),col=tr==='up'?g:tr==='down'?r:mu;const ctx=cv.getContext('2d'),W=cv.width=100,H=cv.height=32,p=3,vs=vals.slice(-20),mn=Math.min(...vs),mx=Math.max(...vs),rg=mx-mn||1;ctx.clearRect(0,0,W,H);ctx.beginPath();vs.forEach((v,i)=>{const x=p+(i/(vs.length-1))*(W-2*p),y=H-p-((v-mn)/rg)*(H-2*p);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.lineTo(p+(W-2*p),H);ctx.lineTo(p,H);ctx.closePath();ctx.fillStyle=col+'18';ctx.fill();ctx.beginPath();vs.forEach((v,i)=>{const x=p+(i/(vs.length-1))*(W-2*p),y=H-p-((v-mn)/rg)*(H-2*p);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.strokeStyle=col;ctx.lineWidth=1.8;ctx.stroke();const lv=vs[vs.length-1],ly=H-p-((lv-mn)/rg)*(H-2*p);ctx.beginPath();ctx.arc(p+(W-2*p),ly,2.5,0,Math.PI*2);ctx.fillStyle=col;ctx.fill();}

function drawSparkBar(cv, series){
  if(!cv || !series || series.length < 1) return;
  const ctx=cv.getContext('2d'), W=cv.width=100, H=cv.height=32, pad=3;
  ctx.clearRect(0,0,W,H);
  const vals=series.map(d=>d.value);
  const mn=Math.min(...vals,0), mx=Math.max(...vals,0), rg=mx-mn||1;
  const n=vals.length, barW=Math.min(28, (W-pad*2)/n - 4), gap=((W-pad*2)-barW*n)/(n+1);
  const zY=H-pad-((0-mn)/rg)*(H-2*pad);
  const green=gc('--green'), red=gc('--red');
  vals.forEach((v,i)=>{
    const x=pad+gap+(barW+gap)*i;
    const yV=H-pad-((v-mn)/rg)*(H-2*pad);
    const top=v>=0?yV:zY, h=Math.max(1,Math.abs(yV-zY));
    ctx.fillStyle=v>=0?green:red;
    ctx.globalAlpha=0.6;
    ctx.beginPath();
    const r=Math.min(2, h/2);
    ctx.moveTo(x+r,top);ctx.lineTo(x+barW-r,top);ctx.quadraticCurveTo(x+barW,top,x+barW,top+r);
    ctx.lineTo(x+barW,top+h-r);ctx.quadraticCurveTo(x+barW,top+h,x+barW-r,top+h);
    ctx.lineTo(x+r,top+h);ctx.quadraticCurveTo(x,top+h,x,top+h-r);
    ctx.lineTo(x,top+r);ctx.quadraticCurveTo(x,top,x+r,top);ctx.fill();
    ctx.globalAlpha=1;
    ctx.font='bold 7px Overpass Mono,monospace';ctx.fillStyle=gc('--text-cell-dim');
    ctx.textAlign='center';ctx.textBaseline='bottom';
    ctx.fillText(series[i].period.slice(-2), x+barW/2, H);
    ctx.font='bold 7px Overpass Mono,monospace';ctx.fillStyle=v>=0?green:red;
    ctx.textBaseline=v>=0?'bottom':'top';
    ctx.fillText(v.toFixed(1).replace('.',','), x+barW/2, v>=0?top-1:top+h+1);
  });
}

function render(){const w=document.getElementById('tableWrap');let h='';const by={};for(const[c,s]of Object.entries(DATA)){const sec=(M[c]||{}).s||'other';if(!by[sec])by[sec]=[];by[sec].push({c,s,m:M[c]});}if(by.other&&!SECTIONS.other)SECTIONS.other={label:{en:'Other',fr:'Autre',nl:'Andere'}};for(const[sid,sm]of Object.entries(SECTIONS)){const it=by[sid];if(!it||!it.length)continue;if(activeFilter&&activeFilter!==sid)continue;it.sort((a,b)=>(a.m?.o||99)-(b.m?.o||99));h+=`<div class="section-head">${sm.label[LANG]||sm.label.en}</div><table><thead><tr><th>#</th><th>${t('th_ind')}</th><th>${t('th_src')}</th><th>${t('th_last')}</th><th>${t('th_val')}</th><th>${t('th_trend')}</th><th>${t('th_vis')}</th><th>${t('th_upd')}</th><th>${t('th_com')}</th></tr></thead><tbody>`;it.forEach(({c,s,m})=>{const l=s[s.length-1],tr=trend(s),nm=m?.name?.[LANG]||l.name||c,tf=m?.full?.[LANG]||nm,td=m?.desc?.[LANG]||'',ts=m?.sdmx||'';
    const isFc = m?.forecast;
    let fr;
    if(isFc) fr=LANG==='fr'?'Pr√©vision':LANG==='nl'?'Prognose':'Forecast';
    else if(m?.freq==='Q') fr=LANG==='fr'?'Trimestriel':LANG==='nl'?'Kwartaal':'Quarterly';
    else if(m?.freq==='M') fr=LANG==='fr'?'Mensuel':LANG==='nl'?'Maandelijks':'Monthly';
    else fr=LANG==='fr'?'Annuel':LANG==='nl'?'Jaarlijks':'Annual';
    let valCell, periodCell;
    if(c === 'INT_GDP_COMP') {
        valCell = `<td class="val" style="font-size:0.7rem;line-height:1.2;white-space:nowrap">BE: ${l.be_value.toFixed(1).replace('.',',')}<br><span style="color:var(--text-cell-muted);font-size:0.65rem">DE/FR/NL: ${l.value.toFixed(1).replace('.',',')}</span></td>`;
        periodCell = `<td style="font-family:'Overpass Mono';font-size:.72rem">${l.period}<br><span style="font-size:0.6rem;color:var(--text-cell-muted)">2010=100</span></td>`;
    } else if (c === 'CONSUMER_CONFIDENCE_COMP') {
        valCell = `<td class="val" style="font-size:0.7rem;line-height:1.2;white-space:nowrap">BE: ${l.value.toFixed(1).replace('.',',')}<br><span style="color:var(--text-cell-muted);font-size:0.65rem">EA: ${l.eu_value.toFixed(1).replace('.',',')}</span></td>`;
        periodCell = `<td style="font-family:'Overpass Mono';font-size:.72rem">${l.period}</td>`;
    } else if(isFc) {
        const parts = s.map(d => `${d.period}: <b>${d.value>=0?'':' '}${d.value.toFixed(1).replace('.',',')}</b>`).join(' ¬∑ ');
        valCell = `<td class="val" style="font-size:0.68rem;white-space:nowrap">${parts}</td>`;
        periodCell = `<td style="font-family:'Overpass Mono';font-size:.72rem">${s.map(d=>d.period).join(', ')}<br><span style="font-size:0.58rem;color:var(--text-cell-muted)">${l._count||'?'} inst.</span></td>`;
    } else {
        valCell = `<td class="val">${fmtV(l.value,l.unit)}</td>`;
        periodCell = `<td style="font-family:'Overpass Mono';font-size:.72rem">${l.period}</td>`;
    }
    let srcBadge;
    if(isFc) srcBadge=`<span class="src-badge" style="background:var(--orange-bg);color:var(--orange);border:1px solid var(--orange)">FPB</span>`;
    else if(l.source==='EC') srcBadge=`<span class="src-badge" style="background:var(--bg-btn-primary);color:var(--text-btn-primary)">${l.source}</span>`;
    else srcBadge=`<span class="src-badge src-nbb">${l.source}</span>`;
    let cmnt;
    if(isFc){
        const avgAll = s.map(d=>d.value.toFixed(1).replace('.',',')).join(' / ');
        const yrLabels = s.map(d=>d.period).join('/');
        cmnt = {en:`Consensus avg ${yrLabels}: ${avgAll}% (${l._count||'?'} institutions, last 6mo)`,
                fr:`Moy. consensus ${yrLabels}: ${avgAll}% (${l._count||'?'} inst., 6 derniers mois)`,
                nl:`Consensusgemiddelde ${yrLabels}: ${avgAll}% (${l._count||'?'} inst., laatste 6 mnd)`}[LANG];
    } else {
        cmnt = comment(c,s);
    }
    h+=`<tr onclick="openModal('${c}')" ${isFc?'style="background:var(--bg-page);opacity:0.92"':''}><td style="font-family:'Overpass Mono';font-size:.7rem">${m?.n||'‚Äî'}</td><td><span class="ind-name">${nm}<div class="tip"><div class="tip-title">${tf}</div><div class="tip-code">${c}${ts?' ¬∑ SDMX: '+ts:''}</div>${td?'<div class="tip-desc">'+td+'</div>':''}<div class="tip-meta"><span>‚è± ${fr}</span><span>üì° ${isFc?'FPB/plan.be':l.source}</span><span>üìä ${s.length} ${t('m_obs')}</span></div></div></span></td><td>${srcBadge}</td>${periodCell}${valCell}<td>${isFc?'<span class="trend flat" style="font-size:.65rem">forecast</span>':tArr(tr)}</td><td><canvas id="sp_${c}" class="spark" width="100" height="32"></canvas></td><td><span class="update-dt">${fmtD(l.fetched_at)}</span></td><td class="comment">${cmnt}</td></tr>`;
});h+='</tbody></table>';}w.innerHTML=h;requestAnimationFrame(()=>{for(const[c,s]of Object.entries(DATA)){
  const cv=document.getElementById('sp_'+c);
  if(M[c]?.forecast) drawSparkBar(cv, s);
  else if (c === 'CONSUMER_CONFIDENCE_COMP') drawSparkBar(cv, s);
  else drawSpark(cv, s.map(d=>d.value), trend(s));
}});renderContribChart();}

function renderPills(){const e=document.getElementById('pills');let h='';for(const[id,s]of Object.entries(SECTIONS))h+=`<span class="pill ${activeFilter===id?'on':''}" onclick="setFilter('${id}',this)">${(s.label[LANG]||s.label.en).toUpperCase()}</span>`;e.innerHTML=h;}
function setFilter(id,el){document.querySelectorAll('.pill').forEach(p=>p.classList.remove('on'));el.classList.add('on');activeFilter=id;render();}

let _modalCode='', _modalData=[];
function openModal(code){
  _modalCode = code;
  const meta = M[code] || {};

  if(meta.forecast && meta.fc_indicator){
    const ind = meta.fc_indicator;
    const name = meta.name?.[LANG] || code;
    const cutoff = new Date(); cutoff.setMonth(cutoff.getMonth()-6);
    const cutStr = cutoff.toISOString().substring(0,10);
    const relevant = FORECASTS_RAW.filter(r => r.indicator===ind && r.updated_at>=cutStr);
    const years = [...new Set(relevant.map(r=>r.year))].sort();
    const instMap = {};
    relevant.forEach(r => {
      if(!instMap[r.institution]) instMap[r.institution]={institution:r.institution, updated_at:r.updated_at};
      instMap[r.institution]['y_'+r.year] = r.value;
      if(r.updated_at > (instMap[r.institution].updated_at||'')) instMap[r.institution].updated_at=r.updated_at;
    });
    const insts = Object.values(instMap).sort((a,b)=>a.institution.localeCompare(b.institution));
    const avgByYear = years.map(yr => {
      const vals = relevant.filter(r=>r.year===yr && r.value!==null).map(r=>r.value);
      return {year:yr, avg:vals.length?vals.reduce((a,b)=>a+b,0)/vals.length:0, count:vals.length,
              min:vals.length?Math.min(...vals):0, max:vals.length?Math.max(...vals):0};
    });
    _modalData = relevant.map(r=>({period:r.year,value:r.value||0,obs_status:'F',unit:'percent_yy'}));

    document.getElementById('modalTitle').textContent=name;
    document.getElementById('modalSub').textContent=`${code} ¬∑ Source: plan.be (FPB) ¬∑ ${insts.length} institutions ¬∑ last 6 months`;
    document.getElementById('modalStats').innerHTML=avgByYear.map(a=>
      `<div class="stat-card"><div class="stat-label">Avg ${a.year} (${a.count} inst.)</div><div class="stat-val">${a.avg.toFixed(2).replace('.',',')}%</div></div>`+
      `<div class="stat-card"><div class="stat-label">Range ${a.year}</div><div class="stat-val" style="font-size:.75rem">${a.min.toFixed(1).replace('.',',')} ‚Äî ${a.max.toFixed(1).replace('.',',')}%</div></div>`
    ).join('');
    document.getElementById('modalChart').style.display='none';
    let tb=`<tr style="background:var(--bg-thead)"><td style="font-weight:600">Institution</td>${years.map(y=>`<td style="font-weight:600;text-align:center">${y}</td>`).join('')}<td style="font-weight:600">Updated</td></tr>`;
    insts.forEach(inst => {
      tb += `<tr><td style="font-size:.72rem">${inst.institution}</td>`;
      years.forEach(yr => {
        const v = inst['y_'+yr];
        if(v===null || v===undefined) tb+=`<td style="text-align:center;color:var(--text-cell-muted)">‚Äî</td>`;
        else {
          const vc = v>=0?'pos-val':'neg-val';
          tb+=`<td class="${vc}" style="text-align:center;font-family:'Overpass Mono';font-size:.72rem">${v.toFixed(1).replace('.',',')}</td>`;
        }
      });
      tb+=`<td style="font-size:.65rem;color:var(--text-cell-muted)">${inst.updated_at||'‚Äî'}</td></tr>`;
    });
    tb+=`<tr style="background:var(--bg-thead);font-weight:600"><td>Consensus avg</td>`;
    avgByYear.forEach(a=>{
      tb+=`<td style="text-align:center;font-family:'Overpass Mono';font-size:.72rem">${a.avg.toFixed(2).replace('.',',')}</td>`;
    });
    tb+=`<td></td></tr>`;
    document.getElementById('modalTableBody').innerHTML=tb;
    document.getElementById('mThPer').textContent='Institution';
    document.getElementById('mThVal').textContent=years[0]||'';
    document.getElementById('mThChg').textContent=years[1]||'';
    document.getElementById('mThStat').textContent='Updated';
    document.getElementById('mThBar').textContent='';
    document.querySelector('.modal-table thead').style.display='none';
    document.getElementById('modalOverlay').classList.add('open');document.body.style.overflow='hidden';
    return;
  }

  let series, displayCode=code;
  if(code==='INT_GDP_COMP' && DATA['EUROSTAT_GDP_Q_MEUR']){
    series = DATA['EUROSTAT_GDP_Q_MEUR'];
    displayCode = 'EUROSTAT_GDP_Q_MEUR';
  } else {
    series = DATA[code];
  }
  if(!series||!series.length)return;
  const name=meta.name?.[LANG]||series[0].name||code,unit=series[0].unit;
  const cutoff=new Date().getFullYear()-10;
  const filtered=series.filter(d=>parseInt(d.period.substring(0,4))>=cutoff);
  const dd=filtered.length>0?filtered:series.slice(-10);
  _modalData = dd;
  
  document.getElementById('modalChart').style.display='';
  document.querySelector('.modal-table thead').style.display='';
  document.getElementById('modalTitle').textContent=name;
  const srcLabel = code==='INT_GDP_COMP' ? 'Eurostat/DBnomics (Belgium)' : series[0].source;
  document.getElementById('modalSub').textContent=`${displayCode} ¬∑ Source: ${srcLabel} ¬∑ ${dd.length} ${t('m_obs')} ¬∑ ${t('m_last10')}`;
  const last=dd[dd.length-1],prev=dd.length>=2?dd[dd.length-2]:null,vals=dd.map(d=>d.value),avg=vals.reduce((a,b)=>a+b,0)/vals.length,chg=prev?last.value-prev.value:0;
  document.getElementById('modalStats').innerHTML=`<div class="stat-card"><div class="stat-label">${t('m_latest')} (${last.period})</div><div class="stat-val ${last.value>=0?'pos':'neg'}">${fmtV(last.value,unit)}</div></div><div class="stat-card"><div class="stat-label">${t('m_chg')}</div><div class="stat-val ${chg>=0?'pos':'neg'}">${chg>=0?'+':''}${chg.toFixed(1).replace('.',',')} ${unit==='balance'?'pts':'p.p.'}</div></div><div class="stat-card"><div class="stat-label">${t('m_avg')}</div><div class="stat-val">${avg.toFixed(1).replace('.',',')}${unit==='balance'?'':'%'}</div></div><div class="stat-card"><div class="stat-label">${t('m_min')}</div><div class="stat-val neg">${fmtV(Math.min(...vals),unit)}</div></div><div class="stat-card"><div class="stat-label">${t('m_max')}</div><div class="stat-val pos">${fmtV(Math.max(...vals),unit)}</div></div>`;
  drawModalChart(dd,unit);
  const am=Math.max(Math.abs(Math.min(...vals)),Math.abs(Math.max(...vals)))||1;
  let tb='';for(let i=dd.length-1;i>=0;i--){
      const d=dd[i],pv=i>0?dd[i-1].value:null,delta=pv!==null?d.value-pv:null,vc=d.value>=0?'pos-val':'neg-val',dc=delta!==null?`<span class="${delta>=0?'pos-val':'neg-val'}">${delta>=0?'+':''}${delta.toFixed(1).replace('.',',')}</span>`:'‚Äî';
      let sb='‚Äî';if(d.obs_status==='A')sb=`<span class="status-badge st-actual">${t('st_act')}</span>`;else if(d.obs_status==='P')sb=`<span class="status-badge st-prov">${t('st_prov')}</span>`;else if(d.obs_status==='B')sb=`<span class="status-badge st-break">${t('st_brk')}</span>`;
      const bw=Math.abs(d.value)/am*50,bc=d.value>=0?'var(--green)':'var(--red)',bl=d.value>=0?'50%':(50-bw)+'%';
      
      let displayVal = `<span class="${vc}">${fmtV(d.value,unit)}</span>`;
      if(code === 'CONSUMER_CONFIDENCE_COMP' && d.eu_value !== undefined) {
          displayVal = `<div style="line-height:1.2; padding-top:2px; padding-bottom:2px;"><span class="${vc}">BE: ${d.value.toFixed(1).replace('.',',')}</span><br><span style="font-size:0.65rem;color:var(--text-cell-muted)">EU: ${d.eu_value.toFixed(1).replace('.',',')}</span></div>`;
      }
      
      tb+=`<tr><td>${d.period}</td><td>${displayVal}</td><td>${dc}</td><td>${sb}</td><td><div style="position:relative;width:100px;height:6px;background:var(--modal-bar-bg);border-radius:3px"><div style="position:absolute;height:100%;border-radius:3px;background:${bc};opacity:.5;left:${bl};width:${bw}%"></div><div style="position:absolute;left:50%;top:-2px;width:1px;height:10px;background:var(--modal-bar-zero)"></div></div></td></tr>`;
  }
  document.getElementById('modalTableBody').innerHTML=tb;
  document.getElementById('modalOverlay').classList.add('open');document.body.style.overflow='hidden';
}
function exportModalCSV(){
  const meta=M[_modalCode]||{};
  if(meta.forecast && meta.fc_indicator){
    const ind=meta.fc_indicator;
    const cutoff=new Date();cutoff.setMonth(cutoff.getMonth()-6);
    const cutStr=cutoff.toISOString().substring(0,10);
    const relevant=FORECASTS_RAW.filter(r=>r.indicator===ind && r.updated_at>=cutStr);
    let csv='Institution,Year,Value,Updated\n';
    relevant.forEach(r=>{csv+=`"${r.institution}",${r.year},${r.value!==null?r.value:''},${r.updated_at}\n`;});
    const blob=new Blob([csv],{type:'text/csv'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download=`${_modalCode}_forecasts.csv`;a.click();URL.revokeObjectURL(a.href);
    return;
  }
  if(!_modalData.length)return;
  let csv='Period,Value,Status\n';
  _modalData.forEach(d=>{csv+=`${d.period},${d.value},${d.obs_status||''}\n`;});
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`${_modalCode}_data.csv`;a.click();URL.revokeObjectURL(a.href);
}
function closeModal(){document.getElementById('modalOverlay').classList.remove('open');document.body.style.overflow='';}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});

function drawModalChart(data,unit){requestAnimationFrame(()=>{requestAnimationFrame(()=>{_rc(data,unit);});});}
function _rc(data,unit){const cv=document.getElementById('modalChart'),ct=cv.parentElement,ctx=cv.getContext('2d'),dpr=window.devicePixelRatio||1,W=ct.clientWidth-40,H=260;cv.width=Math.round(W*dpr);cv.height=Math.round(H*dpr);cv.style.width=W+'px';cv.style.height=H+'px';ctx.setTransform(dpr,0,0,dpr,0,0);ctx.clearRect(0,0,W,H);const vals=data.map(d=>d.value),n=data.length,vMin=Math.min(...vals,0),vMax=Math.max(...vals,0),vR=vMax-vMin||1;const pL=58,pR=18,pT=18,pB=48,cW=W-pL-pR,slW=cW/n,bW=Math.max(8,Math.min(36,slW*.55));const yOf=v=>pT+((vMax-v)/vR)*(H-pT-pB),zY=yOf(0);const gC=gc('--chart-grid'),zC=gc('--chart-zero'),lC=gc('--chart-label'),liC=gc('--chart-line'),dC=gc('--chart-dot'),dR=gc('--chart-dot-ring'),bP=gc('--chart-bar-pos'),bN=gc('--chart-bar-neg');
niceSteps(vMin,vMax,5).forEach(v=>{const y=Math.round(yOf(v))+.5;ctx.strokeStyle=gC;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pL,y);ctx.lineTo(W-pR,y);ctx.stroke();ctx.font='10px Overpass Mono,monospace';ctx.fillStyle=lC;ctx.textAlign='right';ctx.textBaseline='middle';ctx.fillText(v.toFixed(1).replace('.',',')+(unit==='balance'?'':'%'),pL-10,y);});
const zy=Math.round(zY)+.5;ctx.strokeStyle=zC;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pL,zy);ctx.lineTo(W-pR,zy);ctx.stroke();
const maxLabelW=Math.max(...data.map(d=>{ctx.font='9px Overpass Mono,monospace';return ctx.measureText(d.period).width;}));
const xSkip=Math.max(1,Math.ceil((maxLabelW+12)/slW));
data.forEach((d,i)=>{const cx=pL+slW*i+slW/2,vY=yOf(d.value),isP=d.value>=0,bT=isP?vY:zY,bH=Math.max(1,Math.abs(vY-zY)),rgb=isP?bP:bN;ctx.fillStyle=`rgba(${rgb},.55)`;ctx.beginPath();rr(ctx,Math.round(cx-bW/2),bT,bW,bH,3);ctx.fill();if(d.obs_status==='P'){ctx.strokeStyle=`rgba(${rgb},.3)`;ctx.lineWidth=1;ctx.setLineDash([4,3]);ctx.beginPath();rr(ctx,Math.round(cx-bW/2),bT,bW,bH,3);ctx.stroke();ctx.setLineDash([]);}
if(slW>18){ctx.font='9px Overpass Mono,monospace';ctx.fillStyle=`rgba(${rgb},.85)`;ctx.textAlign='center';ctx.textBaseline=isP?'bottom':'top';ctx.fillText(d.value.toFixed(1).replace('.',','),cx,isP?bT-4:bT+bH+4);}
if(i%xSkip===0||i===n-1){ctx.font='9px Overpass Mono,monospace';ctx.fillStyle=lC;ctx.textAlign='center';ctx.textBaseline='top';ctx.fillText(d.period,cx,H-pB+8);}});
ctx.beginPath();data.forEach((d,i)=>{const cx=pL+slW*i+slW/2;i===0?ctx.moveTo(cx,yOf(d.value)):ctx.lineTo(cx,yOf(d.value));});ctx.strokeStyle=liC;ctx.lineWidth=2;ctx.lineJoin='round';ctx.lineCap='round';ctx.stroke();
data.forEach((d,i)=>{const cx=pL+slW*i+slW/2,y=yOf(d.value),isL=i===n-1;ctx.beginPath();ctx.arc(cx,y,isL?4.5:2.5,0,Math.PI*2);ctx.fillStyle=isL?dC:liC;ctx.fill();if(isL){ctx.strokeStyle=dR;ctx.lineWidth=2;ctx.stroke();}});}
function rr(c,x,y,w,h,r){if(h===0)return;c.beginPath();c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.quadraticCurveTo(x+w,y,x+w,y+r);c.lineTo(x+w,y+h-r);c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);c.lineTo(x+r,y+h);c.quadraticCurveTo(x,y+h,x,y+h-r);c.lineTo(x,y+r);c.quadraticCurveTo(x,y,x+r,y);c.closePath();}
function niceSteps(mn,mx,n){const rg=mx-mn||1,ro=rg/n,mg=Math.pow(10,Math.floor(Math.log10(ro))),rs=ro/mg,ni=rs<=1.5?mg:rs<=3?2*mg:rs<=7?5*mg:10*mg;const st=[];let v=Math.ceil(mn/ni)*ni;while(v<=mx){st.push(parseFloat(v.toFixed(4)));v+=ni;}return st;}

function downloadChart(canvasId, name) {
  const cv = document.getElementById(canvasId);
  if (!cv) return;
  
  const card = cv.parentElement;
  const title = card.querySelector('.contrib-title').textContent;
  const sub = card.querySelector('.contrib-sub').textContent;
  const legs = card.querySelectorAll('.contrib-legend .leg');
  
  const dpr = window.devicePixelRatio || 1;
  const padX = 28 * dpr;
  const padYTop = 24 * dpr;
  const padYBot = 18 * dpr;
  
  const titleFontSz = 15.2 * dpr;
  const subFontSz = 11.2 * dpr;
  const legFontSz = 10.88 * dpr;
  
  const titleMb = 2 * dpr;
  const subMb = 16 * dpr;
  
  const legMt = 14 * dpr;
  const legPt = 12 * dpr;
  const legGapX = 16 * dpr;
  const legGapY = 6 * dpr;
  const swatchTextGap = 5 * dpr;
  
  const cardW = card.clientWidth * dpr;
  
  const temp = document.createElement('canvas');
  const ctx = temp.getContext('2d');
  
  ctx.font = `${legFontSz}px Figtree, sans-serif`;
  let legRows = 1;
  let currentX = padX;
  const legItems = [];
  
  legs.forEach(leg => {
    const text = leg.textContent.trim();
    const swatch = leg.querySelector('.swatch');
    const comp = swatch ? getComputedStyle(swatch) : null;
    const color = comp ? comp.backgroundColor : '#000';
    
    const swW = comp ? parseFloat(comp.width) * dpr : 12 * dpr;
    const swH = comp ? parseFloat(comp.height) * dpr : 12 * dpr;
    let swR = 0;
    if (comp && comp.borderRadius && comp.borderRadius !== '0px') {
        swR = parseFloat(comp.borderRadius) * dpr;
    } else if (!comp) {
        swR = 2 * dpr;
    }
    
    const textW = ctx.measureText(text).width;
    const itemW = swW + swatchTextGap + textW;
    
    if (currentX + itemW > cardW - padX && currentX > padX) {
      legRows++;
      currentX = padX;
    }
    legItems.push({ text, color, x: currentX, row: legRows, swW, swH, swR });
    currentX += itemW + legGapX;
  });
  
  const titleH = titleFontSz * 1.2;
  const subH = subFontSz * 1.2;
  const legLineH = Math.max(12 * dpr, legFontSz * 1.2);
  
  const cvY = padYTop + titleH + titleMb + subH + subMb;
  const sepY = cvY + cv.height + legMt;
  const legendTotalH = legPt + (legRows * legLineH) + ((legRows - 1) * legGapY);
  
  temp.width = cardW;
  temp.height = sepY + legendTotalH + padYBot;
  
  ctx.fillStyle = gc('--bg-table');
  ctx.fillRect(0, 0, temp.width, temp.height);
  
  ctx.strokeStyle = gc('--border-table');
  ctx.lineWidth = 1 * dpr;
  ctx.strokeRect(0, 0, temp.width, temp.height);
  
  ctx.fillStyle = gc('--text-cell');
  ctx.font = `bold ${titleFontSz}px Figtree, sans-serif`;
  ctx.textBaseline = 'top';
  ctx.fillText(title, padX, padYTop);
  
  ctx.fillStyle = gc('--text-cell-muted');
  ctx.font = `${subFontSz}px Figtree, sans-serif`;
  ctx.fillText(sub, padX, padYTop + titleH + titleMb);
  
  ctx.drawImage(cv, padX, cvY, cv.width, cv.height);
  
  ctx.beginPath();
  ctx.moveTo(padX, sepY);
  ctx.lineTo(cardW - padX, sepY);
  ctx.stroke();
  
  ctx.font = `${legFontSz}px Figtree, sans-serif`;
  legItems.forEach(item => {
    const y = sepY + legPt + (item.row - 1) * (legLineH + legGapY);
    
    ctx.fillStyle = item.color;
    ctx.beginPath();
    const radius = Math.min(item.swR, item.swW / 2, item.swH / 2);
    rr(ctx, item.x, y + (legLineH - item.swH) / 2, item.swW, item.swH, radius);
    ctx.fill();
    
    ctx.fillStyle = gc('--text-cell-dim');
    ctx.textBaseline = 'middle';
    ctx.fillText(item.text, item.x + item.swW + swatchTextGap, y + legLineH / 2);
  });
  
  const a = document.createElement('a');
  a.download = name + '.png';
  a.href = temp.toDataURL('image/png');
  a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STACKED BAR CHART ‚Äî GDP contributions
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CONTRIB_SERIES = [
  {code:'PRIV_CONSUMPTION_CY', label:{en:'Private consumption',fr:'Consommation priv√©e',nl:'Particuliere consumptie'}, color:'#4292c6'},
  {code:'GOV_CONSUMPTION_CY', label:{en:'Public consumption',fr:'Consommation publique',nl:'Overheidsconsumptie'}, color:'#d6604d'},
  {code:'_PRIV_INVEST', label:{en:'Private investment (business + residential)',fr:'Investissement priv√© (entreprises + logements)',nl:'Particuliere investeringen (bedrijven + woningen)'}, color:'#e8c96a', composite:['GFCF_ENTERPRISES_CY','GFCF_DWELLINGS_CY']},
  {code:'GFCF_PUBLIC_CY', label:{en:'Public investment',fr:'Investissement public',nl:'Overheidsinvesteringen'}, color:'#8c6d31'},
  {code:'CHG_STOCKS_CY', label:{en:'Change in inventories',fr:'Variation des stocks',nl:'Voorraadwijzigingen'}, color:'#bdbdbd'},
  {code:'NET_EXPORTS_CY', label:{en:'Net exports',fr:'Exportations nettes',nl:'Netto-export'}, color:'#74a9cf'},
];

function renderContribChart() {
  const wrap = document.getElementById('contribWrap');
  if (activeFilter !== 'gdp') { wrap.style.display = 'none'; return; }

  const gdp = DATA['GDP_ANNUAL_CY'];
  const hasContrib = CONTRIB_SERIES.every(s => {
    if (s.composite) return s.composite.every(c => DATA[c] && DATA[c].length > 0);
    return DATA[s.code] && DATA[s.code].length > 0;
  });
  const hasIntl = DATA['EUROSTAT_GDP_Q_MEUR'] && DATA['EUROSTAT_GDP_Q_MEUR_DE'] && DATA['EUROSTAT_GDP_Q_MEUR_FR'] && DATA['EUROSTAT_GDP_Q_MEUR_NL'];

  if (!gdp && !hasContrib && !hasIntl) { wrap.style.display = 'none'; return; }
  wrap.style.display = 'flex';

  const contribCard = wrap.querySelector('.contrib-card:first-child');
  if (gdp && hasContrib) {
    contribCard.style.display = '';
    const titles = {en:'Annual real GDP growth and contributions', fr:'Croissance annuelle r√©elle du PIB et contributions', nl:'Jaarlijkse re√´le BBP-groei en bijdragen'};
    document.getElementById('contribTitle').textContent = titles[LANG] || titles.en;

    const cutoff = new Date().getFullYear() - 14;
    const years = gdp.filter(d => parseInt(d.period) >= cutoff).map(d => d.period);

    const yearData = years.map(yr => {
      const obj = { year: yr, gdp: gdp.find(d => d.period === yr)?.value || 0 };
      CONTRIB_SERIES.forEach(s => {
        if (s.composite) {
          obj[s.code] = s.composite.reduce((sum, c) => {
            const match = (DATA[c] || []).find(d => d.period === yr);
            return sum + (match ? match.value : 0);
          }, 0);
        } else {
          const match = (DATA[s.code] || []).find(d => d.period === yr);
          obj[s.code] = match ? match.value : 0;
        }
      });
      return obj;
    });

    const legEl = document.getElementById('contribLegend');
    legEl.innerHTML = CONTRIB_SERIES.map(s =>
      `<div class="leg"><div class="swatch" style="background:${s.color}"></div>${s.label[LANG]||s.label.en}</div>`
    ).join('') + `<div class="leg"><div class="swatch" style="background:var(--text-cell);border-radius:0;height:2px;margin-top:5px"></div>GDP (growth in %)</div>`;

    requestAnimationFrame(() => { requestAnimationFrame(() => { _drawContrib(yearData); }); });
  } else {
    contribCard.style.display = 'none';
  }
  renderIntlChart();
}

function _drawContrib(yearData) {
  const cv = document.getElementById('contribCanvas');
  const ct = cv.parentElement;
  const ctx = cv.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = ct.clientWidth - 56;
  const H = 340;
  cv.width = Math.round(W * dpr); cv.height = Math.round(H * dpr);
  cv.style.width = W + 'px'; cv.style.height = H + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, W, H);

  const n = yearData.length;
  const pL = 48, pR = 12, pT = 22, pB = 42;
  const cW = W - pL - pR, cH = H - pT - pB;
  const slW = cW / n;
  const barW = Math.max(10, Math.min(42, slW * 0.6));

  let stackMin = 0, stackMax = 0;
  yearData.forEach(yd => {
    let posSum = 0, negSum = 0;
    CONTRIB_SERIES.forEach(s => {
      const v = yd[s.code];
      if (v >= 0) posSum += v; else negSum += v;
    });
    stackMax = Math.max(stackMax, posSum, yd.gdp);
    stackMin = Math.min(stackMin, negSum, yd.gdp);
  });
  const vMin = Math.floor(stackMin - 1);
  const vMax = Math.ceil(stackMax + 1);
  const vR = vMax - vMin || 1;
  const yOf = v => pT + ((vMax - v) / vR) * cH;
  const zeroY = yOf(0);

  const gridC = gc('--chart-grid') || 'rgba(0,0,0,.06)';
  const zeroC = gc('--chart-zero') || 'rgba(0,0,0,.12)';
  const labelC = gc('--chart-label') || '#94a3b8';
  const textC = gc('--text-cell') || '#1e293b';

  const steps = niceSteps(vMin, vMax, 6);
  steps.forEach(v => {
    const y = Math.round(yOf(v)) + 0.5;
    ctx.strokeStyle = gridC; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pL, y); ctx.lineTo(W - pR, y); ctx.stroke();
    ctx.font = '10px Overpass Mono, monospace'; ctx.fillStyle = labelC;
    ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
    ctx.fillText(v.toFixed(0), pL - 8, y);
  });

  const zy = Math.round(zeroY) + 0.5;
  ctx.strokeStyle = zeroC; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(pL, zy); ctx.lineTo(W - pR, zy); ctx.stroke();

  ctx.save(); ctx.translate(12, pT + cH / 2); ctx.rotate(-Math.PI / 2);
  ctx.font = '10px Figtree, sans-serif'; ctx.fillStyle = labelC;
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText('in %', 0, 0); ctx.restore();

  yearData.forEach((yd, i) => {
    const cx = pL + slW * i + slW / 2;
    let posY = zeroY;
    let negY = zeroY;

    CONTRIB_SERIES.forEach(s => {
      const v = yd[s.code];
      if (Math.abs(v) < 0.001) return;
      const h = Math.abs(v / vR) * cH;

      if (v >= 0) {
        const top = posY - h;
        ctx.fillStyle = s.color;
        ctx.fillRect(Math.round(cx - barW / 2), top, barW, h);
        ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth = 0.5;
        ctx.strokeRect(Math.round(cx - barW / 2), top, barW, h);
        posY = top;
      } else {
        const top = negY;
        ctx.fillStyle = s.color;
        ctx.fillRect(Math.round(cx - barW / 2), top, barW, h);
        ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth = 0.5;
        ctx.strokeRect(Math.round(cx - barW / 2), top, barW, h);
        negY = top + h;
      }
    });

    ctx.font = '10px Overpass Mono, monospace'; ctx.fillStyle = labelC;
    ctx.textAlign = 'center'; ctx.textBaseline = 'top';
    ctx.fillText(yd.year, cx, H - pB + 8);
  });

  ctx.beginPath();
  yearData.forEach((yd, i) => {
    const cx = pL + slW * i + slW / 2;
    const y = yOf(yd.gdp);
    i === 0 ? ctx.moveTo(cx, y) : ctx.lineTo(cx, y);
  });
  ctx.strokeStyle = textC; ctx.lineWidth = 2.5;
  ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.stroke();

  yearData.forEach((yd, i) => {
    const cx = pL + slW * i + slW / 2;
    const y = yOf(yd.gdp);
    ctx.beginPath(); ctx.arc(cx, y, 3.5, 0, Math.PI * 2);
    ctx.fillStyle = gc('--bg-table') || '#fff'; ctx.fill();
    ctx.strokeStyle = textC; ctx.lineWidth = 2; ctx.stroke();
    ctx.font = 'bold 10px Figtree, sans-serif'; ctx.fillStyle = textC;
    ctx.textAlign = 'center';
    ctx.textBaseline = yd.gdp >= 0 ? 'bottom' : 'top';
    const offset = yd.gdp >= 0 ? -10 : 10;
    ctx.fillText(yd.gdp.toFixed(1).replace('.', ','), cx, y + offset);
  });

  ctx.font = '9px Figtree, sans-serif'; ctx.fillStyle = labelC;
  ctx.textAlign = 'right'; ctx.textBaseline = 'bottom';
  ctx.fillText('Source: NBB', W - pR, H - 2);

  cv.onmousemove = e => {
    const rect = cv.getBoundingClientRect();
    const cw = rect.width - pL - pR;
    let i = Math.floor((e.clientX - rect.left - pL) / (cw / n));
    if (i < 0) i = 0; if (i >= n) i = n - 1;
    const yd = yearData[i];
    const tt = document.getElementById('chartTooltip');
    
    let h = `<div class="tt-title">${yd.year}</div>`;
    CONTRIB_SERIES.forEach(s => {
      const v = yd[s.code];
      if (Math.abs(v) > 0.001) h += `<div class="tt-row"><span><span class="tt-swatch" style="background:${s.color}"></span>${s.label[LANG]||s.label.en}</span><strong>${v.toFixed(2).replace('.',',')} p.p.</strong></div>`;
    });
    h += `<hr style="border:none;border-top:1px solid var(--border-tip);margin:8px 0">`;
    h += `<div class="tt-row"><span>${LANG==='fr'?'Croissance PIB':LANG==='nl'?'BBP Groei':'GDP Growth'}</span><strong style="font-family:'Overpass Mono'">${yd.gdp.toFixed(1).replace('.',',')}%</strong></div>`;
    
    tt.innerHTML = h;
    tt.style.opacity = 1;
    
    let tx = e.clientX + 15, ty = e.clientY + 15;
    tt.style.left = tx + 'px'; tt.style.top = ty + 'px';
    const tr = tt.getBoundingClientRect();
    if(tr.right > window.innerWidth) tt.style.left = (e.clientX - tr.width - 15) + 'px';
    if(tr.bottom > window.innerHeight) tt.style.top = (e.clientY - tr.height - 15) + 'px';
  };
  cv.onmouseout = () => { document.getElementById('chartTooltip').style.opacity = 0; };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MULTI-LINE CHART ‚Äî International GDP comparison
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const INTL_SERIES = [
  {code:'EUROSTAT_GDP_Q_MEUR_EA', label:'Euro Area', color:'#dc2626', width:2.5},
  {code:'EUROSTAT_GDP_Q_MEUR',    label:'BE',        color:'_theme_', width:3},
  {code:'EUROSTAT_GDP_Q_MEUR_DE', label:'DE',        color:'#84cc16', width:2},
  {code:'EUROSTAT_GDP_Q_MEUR_ES', label:'ES',        color:'#3b82f6', width:2},
  {code:'_COMPOSITE_DEFRNL',      label:'DE/FR/NL',  color:'#f59e0b', width:2, composite:true},
];

function renderIntlChart() {
  const card = document.getElementById('intlCard');
  const be = DATA['EUROSTAT_GDP_Q_MEUR'];
  const de = DATA['EUROSTAT_GDP_Q_MEUR_DE'];
  const fr = DATA['EUROSTAT_GDP_Q_MEUR_FR'];
  const nl = DATA['EUROSTAT_GDP_Q_MEUR_NL'];
  if(!be || !de || !fr || !nl) { card.style.display='none'; return; }
  card.style.display='';

  const titles = {en:'Quarterly real GDP growth',fr:'Croissance trimestrielle du PIB r√©el',nl:'Kwartaal re√´el BBP-groei'};
  document.getElementById('intlTitle').textContent = titles[LANG]||titles.en;

  const compData = [];
  be.forEach(b => {
    const d=de.find(x=>x.period===b.period), f=fr.find(x=>x.period===b.period), n=nl.find(x=>x.period===b.period);
    if(d&&f&&n) compData.push({period:b.period, value: d.value*0.5 + f.value*0.4 + n.value*0.1});
  });
  DATA['_COMPOSITE_DEFRNL'] = compData;

  const legEl = document.getElementById('intlLegend');
  legEl.innerHTML = INTL_SERIES.map(s => {
    const col = s.color === '_theme_' ? 'var(--text-cell)' : s.color;
    return `<div class="leg"><div class="swatch" style="background:${col};height:${s.width>2?3:2}px;border-radius:0;margin-top:5px"></div>${s.label}</div>`;
  }).join('');

  requestAnimationFrame(()=>{requestAnimationFrame(()=>{_drawIntl();});});
}

function _drawIntl() {
  const cv = document.getElementById('intlCanvas');
  const ct = cv.parentElement;
  const ctx = cv.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = ct.clientWidth - 56;
  const H = 340;
  cv.width = Math.round(W*dpr); cv.height = Math.round(H*dpr);
  cv.style.width = W+'px'; cv.style.height = H+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,W,H);

  const be = DATA['EUROSTAT_GDP_Q_MEUR'];
  if(!be || !be.length) return;
  const periods = be.map(d=>d.period);
  const n = periods.length;

  let allVals = [];
  INTL_SERIES.forEach(s => {
    const src = s.composite ? DATA['_COMPOSITE_DEFRNL'] : DATA[s.code];
    if(src) src.forEach(d => { if(typeof d.value==='number') allVals.push(d.value); });
  });
  if(!allVals.length) return;

  const pL=50, pR=14, pT=16, pB=52;
  const cW=W-pL-pR, cH=H-pT-pB;

  const rawMin=Math.min(...allVals), rawMax=Math.max(...allVals);
  const vMin=Math.floor(rawMin/5)*5, vMax=Math.ceil(rawMax/5)*5;
  const vR=vMax-vMin||1;
  const yOf=v=>pT+((vMax-v)/vR)*cH;

  const gridC=gc('--chart-grid')||'rgba(0,0,0,.06)';
  const labelC=gc('--chart-label')||'#94a3b8';

  const yStep = vMax-vMin > 30 ? 5 : (vMax-vMin > 15 ? 5 : 2);
  for(let v=vMin; v<=vMax; v+=yStep){
    const y=Math.round(yOf(v))+0.5;
    ctx.strokeStyle=gridC; ctx.lineWidth=1; ctx.setLineDash([4,3]);
    ctx.beginPath(); ctx.moveTo(pL,y); ctx.lineTo(W-pR,y); ctx.stroke();
    ctx.setLineDash([]);
    ctx.font='10px Overpass Mono,monospace'; ctx.fillStyle=labelC;
    ctx.textAlign='right'; ctx.textBaseline='middle';
    ctx.fillText(v.toString(), pL-8, y);
  }

  ctx.save(); ctx.translate(11, pT+cH/2); ctx.rotate(-Math.PI/2);
  ctx.font='10px Figtree,sans-serif'; ctx.fillStyle=labelC;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('2010 = 100', 0, 0); ctx.restore();

  const maxLblW = 52;
  const xStep = Math.max(1, Math.ceil((maxLblW+8) / (cW/n)));
  periods.forEach((p,i) => {
    if(i % xStep !== 0 && i !== n-1) return;
    const x = pL + (i/(n-1))*cW;
    ctx.save();
    ctx.translate(x, H-pB+10);
    ctx.rotate(-Math.PI/4);
    ctx.font='8.5px Overpass Mono,monospace'; ctx.fillStyle=labelC;
    ctx.textAlign='right'; ctx.textBaseline='top';
    ctx.fillText(p, 0, 0);
    ctx.restore();
  });

  const drawOrder = [3, 4, 2, 0, 1];
  drawOrder.forEach(si => {
    const s = INTL_SERIES[si];
    const src = s.composite ? DATA['_COMPOSITE_DEFRNL'] : DATA[s.code];
    if(!src || !src.length) return;

    ctx.beginPath();
    let started = false;
    periods.forEach((p,i) => {
      const d = src.find(x=>x.period===p);
      if(!d) return;
      const x = pL + (i/(n-1))*cW;
      const y = yOf(d.value);
      if(!started){ ctx.moveTo(x,y); started=true; }
      else ctx.lineTo(x,y);
    });
    ctx.strokeStyle = s.color === '_theme_' ? (gc('--text-cell')||'#1e293b') : s.color;
    ctx.lineWidth = s.width;
    ctx.lineJoin = 'round'; ctx.lineCap = 'round';
    ctx.stroke();
  });

  ctx.font='9px Figtree,sans-serif'; ctx.fillStyle=labelC;
  ctx.textAlign='right'; ctx.textBaseline='bottom';
  ctx.fillText('Source: Eurostat', W-pR, H-2);

  cv.onmousemove = e => {
    const rect = cv.getBoundingClientRect();
    const cw = rect.width - pL - pR;
    let i = Math.round((e.clientX - rect.left - pL) / (cw / (n - 1)));
    if (i < 0) i = 0; if (i >= n) i = n - 1;
    const p = periods[i];
    const tt = document.getElementById('chartTooltip');
    
    let h = `<div class="tt-title">${p}</div>`;
    INTL_SERIES.forEach(si => {
      const src = si.composite ? DATA['_COMPOSITE_DEFRNL'] : DATA[si.code];
      if(src) {
        const d = src.find(x => x.period === p);
        if(d) {
          const col = si.color === '_theme_' ? gc('--text-cell') : si.color;
          h += `<div class="tt-row"><span><span class="tt-swatch" style="background:${col}"></span>${si.label}</span><strong style="font-family:'Overpass Mono'">${d.value.toFixed(1).replace('.',',')}</strong></div>`;
        }
      }
    });
    
    tt.innerHTML = h;
    tt.style.opacity = 1;
    
    let tx = e.clientX + 15, ty = e.clientY + 15;
    tt.style.left = tx + 'px'; tt.style.top = ty + 'px';
    const tr = tt.getBoundingClientRect();
    if(tr.right > window.innerWidth) tt.style.left = (e.clientX - tr.width - 15) + 'px';
    if(tr.bottom > window.innerHeight) tt.style.top = (e.clientY - tr.height - 15) + 'px';
  };
  cv.onmouseout = () => { document.getElementById('chartTooltip').style.opacity = 0; };
}

function init(){updateStaticUI();document.getElementById('btn-'+LANG).classList.add('active');loadTheme();renderPills();fetchData();}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
